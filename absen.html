<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pagar Nusa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --pn-green: #166534; }
        body { background-color: #f3f4f6; font-family: sans-serif; overflow-x: hidden; }
        #reader { border: none !important; border-radius: 1.5rem; overflow: hidden; }
        .modal-active { display: flex !important; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-[#166534] text-white p-6 text-center shadow-lg">
        <h1 class="text-sm font-bold tracking-[0.2em] uppercase">Absensi UKT Digital</h1>
        <p class="text-[10px] opacity-70 uppercase mt-1">Pagar Nusa UNUSIA</p>
    </header>

    <main class="flex-1 p-6 flex flex-col items-center justify-start">
        <div class="w-full max-w-sm bg-white rounded-[2rem] shadow-xl p-4 mb-6">
            <div id="reader" class="bg-black"></div>
            <div id="status-info" class="mt-4 text-center py-3 px-4 bg-gray-50 rounded-2xl text-[10px] font-black text-gray-400 uppercase tracking-widest transition-all">
                Siap Memindai...
            </div>
        </div>

        <div class="text-center space-y-2">
            <p class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Arahkan kamera ke QR Code ID Card</p>
            <div class="flex justify-center gap-1">
                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
            </div>
        </div>
    </main>

    <div id="modalAbsen" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] overflow-hidden shadow-2xl scale-95 animate-in zoom-in duration-300">
            <div class="bg-emerald-50 py-8 text-center border-b border-emerald-100">
                <div class="text-6xl mb-3">✅</div>
                <h2 class="text-xl font-black text-emerald-900 tracking-tight">ABSEN BERHASIL</h2>
            </div>
            
            <div class="p-8 space-y-5 text-sm">
                <div>
                    <label class="text-[10px] font-black text-gray-300 uppercase tracking-widest">Nama Peserta</label>
                    <p id="pop-nama" class="font-bold text-gray-800 uppercase text-lg leading-tight">---</p>
                </div>
                <div class="flex justify-between items-end gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] font-black text-gray-300 uppercase tracking-widest">Strip</label>
                        <p id="pop-strip" class="font-bold text-emerald-700 uppercase italic">---</p>
                    </div>
                    <div class="text-right">
                        <label class="text-[10px] font-black text-gray-300 uppercase tracking-widest">Waktu</label>
                        <p id="pop-waktu" class="font-bold text-gray-500 italic">---</p>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-gray-50">
                <button onclick="closeModal()" class="w-full bg-[#166534] text-white py-4 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-lg shadow-emerald-900/20 active:scale-95 transition-all">
                    OK, LANJUT SCAN
                </button>
            </div>
        </div>
    </div>

    <script>
        // 1. MASUKKAN URL WEB APP ANDA DI SINI
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbypkLAOISZHAnGagYziGq_RmWKAdUZMe3qXzu4ebAUbzN4wptTHwJ2ei8jNQVSr3a89ig/exec";

        let isProcessing = false;
        const html5QrCode = new Html5Qrcode("reader");

        function onScanSuccess(decodedText) {
            if (isProcessing) return;
            isProcessing = true;

            const statusInfo = document.getElementById('status-info');
            statusInfo.innerText = "⌛ MENGIRIM DATA...";
            statusInfo.className = "mt-4 text-center py-3 px-4 bg-emerald-50 rounded-2xl text-[10px] font-black text-emerald-600 uppercase tracking-widest";

            if (navigator.vibrate) navigator.vibrate(100);

            // Mengirim data ke doPost(e) di Google Script
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ data: decodedText })
            })
            .then(() => {
                // Karena no-cors, kita pecah manual datanya untuk ditampilkan di Modal
                const parts = decodedText.split('|');
                const now = new Date();
                const jam = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                
                showModal(
                    parts[1] || "Peserta", 
                    parts[2] || "-", 
                    jam + " WIB"
                );
            })
            .catch(err => {
                alert("GAGAL MENGIRIM: " + err);
                resetScanner();
            });
        }

        function showModal(nama, strip, waktu) {
            document.getElementById('pop-nama').innerText = nama;
            document.getElementById('pop-strip').innerText = strip;
            document.getElementById('pop-waktu').innerText = waktu;
            document.getElementById('modalAbsen').classList.add('modal-active');
        }

        function closeModal() {
            document.getElementById('modalAbsen').classList.remove('modal-active');
            resetScanner();
        }

        function resetScanner() {
            const statusInfo = document.getElementById('status-info');
            statusInfo.innerText = "Siap Memindai...";
            statusInfo.className = "mt-4 text-center py-3 px-4 bg-gray-50 rounded-2xl text-[10px] font-black text-gray-400 uppercase tracking-widest";
            isProcessing = false;
        }

        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length > 0) {
                const backCamera = cameras.find(cam => cam.label.toLowerCase().includes('back')) || cameras[cameras.length - 1];
                html5QrCode.start(backCamera.id, { fps: 20, qrbox: { width: 250, height: 250 } }, onScanSuccess);
            }
        }).catch(err => { alert("Kamera bermasalah: " + err); });
    </script>
</body>
</html>
