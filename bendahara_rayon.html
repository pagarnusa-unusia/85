<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEM KEUANGAN & IURAN - PAGARNUSA</title>
    <link rel="icon" href="logopn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { pnGreen: '#1B7548', pnDark: '#0b3d26', pnAccent: '#ffcc00' },
                    borderRadius: { '4xl': '2rem', '5xl': '3rem' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .gradient-pn { background: linear-gradient(135deg, #1B7548 0%, #0b3d26 100%); }
        .card-shadow { box-shadow: 0 20px 50px -12px rgba(0,0,0,0.05); }
        .animate-slide { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .progress-bar { transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1); }
        tr { transition: all 0.2s ease; }
    </style>
</head>
<body class="min-h-screen pb-24 lg:pb-0 bg-[#F8FAFC]">

    <header class="sticky top-0 z-50 glass px-4 py-3 lg:px-12 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 lg:w-12 lg:h-12 flex items-center justify-center p-1 bg-white rounded-xl shadow-sm border border-slate-100">
                <img src="logopn.png" class="w-full h-full object-contain" alt="Logo">
            </div>
            <div>
                <h1 class="text-sm lg:text-xl font-black text-pnDark tracking-tighter leading-none uppercase" id="display-nama">BRANKAS IURAN</h1>
                <p class="text-[8px] lg:text-[10px] font-bold text-pnGreen uppercase tracking-[0.0em] mt-1">PSNU PAGARNUSA UNUSIA</p>
            </div>
        </div>
        
        <div class="flex gap-2">
            <button onclick="generateMonthlyReport()" class="w-10 h-10 flex items-center justify-center bg-white text-pnGreen border border-slate-200 rounded-xl hover:bg-pnGreen/5 active:scale-90 transition-all shadow-sm" title="Laporan PDF">
                <i class="fas fa-file-pdf"></i>
            </button>
            <button onclick="logout()" class="w-10 h-10 flex items-center justify-center bg-white text-red-500 border border-slate-200 rounded-xl hover:bg-red-50 active:scale-90 transition-all shadow-sm" title="Keluar">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </header>

    <main class="p-4 lg:p-12 max-w-7xl mx-auto space-y-6 lg:space-y-10">
        
        <section class="grid grid-cols-2 lg:grid-cols-3 gap-3 lg:gap-6">
            <div class="col-span-2 lg:col-span-1 gradient-pn p-6 lg:p-8 rounded-[2rem] shadow-xl shadow-pnDark/20 text-white relative overflow-hidden group border border-white/10">
                <p class="text-[9px] font-black text-white/50 tracking-widest mb-2 uppercase italic">Verified Balance</p>
                <h3 id="stat-Saldo" class="text-2xl lg:text-4xl font-black text-pnAccent tracking-tight">Rp 0</h3>
                <i class="fas fa-wallet absolute -right-4 -bottom-4 text-7xl opacity-10 group-hover:scale-110 transition-transform duration-500"></i>
            </div>

            <div class="bg-white p-5 lg:p-8 rounded-[2rem] card-shadow border border-slate-50 group hover:border-pnGreen/20 transition-all">
                <div class="flex justify-between items-start mb-3">
                    <p class="text-[9px] font-black text-slate-400 tracking-widest uppercase">Total Masuk</p>
                    <span class="bg-green-50 text-green-600 p-2 rounded-lg text-[10px]"><i class="fas fa-vault"></i></span>
                </div>
                <h3 id="stat-TotalMasuk" class="text-lg lg:text-3xl font-black text-pnDark tracking-tight">Rp 0</h3>
            </div>

            <div class="bg-white p-5 lg:p-8 rounded-[2rem] card-shadow border border-slate-50 relative overflow-hidden group">
                <div class="flex justify-between items-start mb-3">
                    <p class="text-[9px] font-black text-slate-400 tracking-widest uppercase">Target Bulan Ini</p>
                    <span id="target-percent" class="bg-pnGreen/10 text-pnGreen px-2 py-0.5 rounded-md text-[9px] font-black italic">0%</span>
                </div>
                <h3 id="stat-BulanIni" class="text-lg lg:text-3xl font-black text-pnGreen mb-4 tracking-tight">Rp 0</h3>
                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                    <div id="progress-bar-inner" class="progress-bar h-full bg-pnAccent rounded-full w-0"></div>
                </div>
                <p class="text-[8px] mt-2 text-slate-400 font-bold">Basis: <span id="total-santri-target">0</span> Santri aktif</p>
            </div>
        </section>

        <section class="bg-white p-6 lg:p-8 rounded-[2.5rem] card-shadow border border-slate-50">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-1 h-6 bg-pnGreen rounded-full"></div>
                <h4 class="text-xs lg:text-sm font-black text-pnDark tracking-widest uppercase italic">Visualisasi Arus Kas</h4>
            </div>
            <div class="h-56 lg:h-72">
                <canvas id="pemasukanChart"></canvas>
            </div>
        </section>

        <div class="bg-white rounded-[2.5rem] lg:rounded-[3.5rem] card-shadow overflow-hidden border border-slate-100">
            <div class="p-6 lg:p-10 flex flex-col lg:flex-row justify-between items-center gap-4 bg-slate-50/50">
                <div class="flex items-center gap-3 w-full lg:w-auto">
                    <div class="w-10 h-10 bg-pnAccent rounded-2xl flex items-center justify-center text-pnDark shadow-sm">
                        <i class="fas fa-list-ul text-xs"></i>
                    </div>
                    <div>
                        <h4 class="text-sm lg:text-lg font-black text-pnDark tracking-tight uppercase">Riwayat Transaksi</h4>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest italic">Live Sync Dashboard</p>
                    </div>
                </div>
                <div class="relative w-full lg:w-96 group">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-pnGreen transition-colors text-xs"></i>
                    <input type="text" onkeyup="filterData(this.value)" placeholder="Cari nama atau bulan..." class="w-full pl-12 pr-6 py-3.5 lg:py-4 bg-white rounded-2xl border border-slate-200 focus:ring-4 focus:ring-pnGreen/10 focus:border-pnGreen outline-none text-xs font-semibold transition-all shadow-inner">
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left min-w-[800px] lg:min-w-full" id="mainTable">
                    <thead class="text-[10px] font-black text-slate-400 tracking-widest uppercase bg-white border-b border-slate-50">
                        <tr>
                            <th class="px-6 lg:px-10 py-5">Nama Anggota</th>
                            <th class="px-6 lg:px-10 py-5">Keterangan</th>
                            <th class="px-6 lg:px-10 py-5">Nominal</th>
                            <th class="px-6 lg:px-10 py-5">Waktu</th>
                            <th class="px-6 lg:px-10 py-5">Lampiran</th>
                            <th class="px-6 lg:px-10 py-5 text-center">Status</th>
                            <th class="px-6 lg:px-10 py-5 text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tBody" class="text-[11px] lg:text-xs divide-y divide-slate-50">
                        </tbody>
                </table>
            </div>
            
            <div class="p-6 bg-slate-50/30 text-center border-t border-slate-50">
                <p class="text-[9px] font-black text-slate-300 uppercase tracking-[0.3em]">End of Data Records</p>
            </div>
        </div>
    </main>

    <div class="lg:hidden fixed bottom-6 right-6 z-[60]">
        <button onclick="openModal()" class="w-16 h-16 gradient-pn text-white rounded-full shadow-2xl shadow-pnGreen/40 flex items-center justify-center text-2xl active:scale-90 transition-all border-4 border-white">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div class="hidden lg:block fixed bottom-10 right-10 z-[60]">
        <button onclick="openModal()" class="gradient-pn text-white px-8 py-4 rounded-2xl flex items-center gap-3 shadow-2xl shadow-pnGreen/30 hover:-translate-y-1 active:translate-y-0 transition-all font-black text-xs uppercase tracking-widest">
            <i class="fas fa-plus-circle text-lg"></i> Tambah Transaksi
        </button>
    </div>

<div id="modal" class="fixed inset-0 z-[70] hidden flex items-end lg:items-center justify-center bg-pnDark/90 backdrop-blur-xl p-0 lg:p-6">
        <div class="bg-white w-full max-w-lg rounded-t-[3rem] lg:rounded-[3.5rem] shadow-2xl overflow-hidden animate-slide">
            
            <div class="p-6 lg:p-10 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-pnGreen text-white rounded-2xl flex items-center justify-center shadow-lg shadow-pnGreen/20">
                        <i class="fas fa-file-invoice-dollar text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-pnDark uppercase tracking-tighter text-lg lg:text-xl leading-none">Catat Iuran</h3>
                        <p class="text-[9px] font-bold text-pnGreen uppercase tracking-widest mt-1">Input Data Transaksi</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-sm text-slate-300 hover:text-red-500 hover:rotate-90 transition-all duration-300">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <form id="iuranForm" class="p-6 lg:p-10 space-y-5 lg:space-y-6">
                
                <div class="group">
                    <label class="inline-block text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 tracking-widest">
                        <i class="fas fa-user-circle mr-1"></i> Nama Lengkap Santri
                    </label>
                    <div class="relative">
                        <input type="text" id="f-nama" required placeholder="Ketik nama anggota..." 
                        class="w-full p-4 lg:p-5 bg-slate-50 rounded-2xl lg:rounded-3xl border-2 border-transparent font-bold text-sm focus:bg-white focus:border-pnGreen outline-none transition-all shadow-inner group-focus-within:shadow-pnGreen/5">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="group">
                        <label class="inline-block text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 tracking-widest">
                            <i class="fas fa-calendar-alt mr-1"></i> Bulan
                        </label>
                        <div class="relative">
                            <select id="f-bulan" class="w-full p-4 lg:p-5 bg-slate-50 rounded-2xl lg:rounded-3xl border-2 border-transparent font-bold text-sm outline-none focus:bg-white focus:border-pnGreen transition-all shadow-inner appearance-none cursor-pointer">
                                <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option>
                                <option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option>
                                <option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-5 top-1/2 -translate-y-1/2 text-slate-300 text-[10px] pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="group">
                        <label class="inline-block text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 tracking-widest">
                            <i class="fas fa-clock mr-1"></i> Tanggal
                        </label>
                        <input type="date" id="f-tgl" required class="w-full p-4 lg:p-5 bg-slate-50 rounded-2xl lg:rounded-3xl border-2 border-transparent font-bold text-sm outline-none focus:bg-white focus:border-pnGreen transition-all shadow-inner">
                    </div>
                </div>

                <div class="group">
                    <label class="inline-block text-[10px] font-black text-slate-400 uppercase ml-2 mb-2 tracking-widest text-pnGreen">
                        <i class="fas fa-coins mr-1"></i> Nominal Setoran
                    </label>
                    <div class="relative">
                        <div class="absolute left-6 top-1/2 -translate-y-1/2 flex flex-col items-center">
                            <span class="font-black text-pnGreen text-xs">IDR</span>
                        </div>
                        <input type="number" id="f-nominal" value="25000" required 
                        class="w-full pl-16 pr-6 py-5 lg:py-6 bg-emerald-50/50 rounded-2xl lg:rounded-3xl border-2 border-transparent font-black text-2xl lg:text-3xl text-pnDark focus:bg-white focus:border-pnGreen outline-none transition-all shadow-inner">
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" id="submitBtn" class="w-full py-5 lg:py-6 gradient-pn text-white rounded-2xl lg:rounded-3xl font-black text-xs lg:text-sm uppercase tracking-[0.2em] shadow-2xl shadow-pnGreen/30 active:scale-[0.97] transition-all flex items-center justify-center gap-3">
                        <span>Konfirmasi & Simpan</span>
                        <i class="fas fa-arrow-right text-[10px]"></i>
                    </button>
                    <p class="text-center text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-4">
                        <i class="fas fa-shield-alt mr-1"></i> Transaksi akan dicatat secara realtime ke Cloud
                    </p>
                </div>
            </form>
        </div>
    </div>
<script>
    // --- KONFIGURASI & STATE ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkOhlAKxKqRJWYgZ5ajptbx1J0QstJ4jdFcJEbcrA2lTdwgEZ63JTuBC8GHNP1nZkcyQ/exec";
    const TARGET_PER_BULAN = 20000;
    let allData = [];
    let listSantri = [];
    let myChart;

    // --- 1. VALIDASI SESI (KONSISTEN) ---
    function validateSesi() {
        const profil = localStorage.getItem('currentUserProfile');
        if (!profil) { window.location.href = 'login.html'; return; }
        const userObj = JSON.parse(profil);
        if(userObj.username) {
            const displayNama = document.getElementById('display-nama');
            if(displayNama) displayNama.innerText = "BRANKAS IURAN"
        }
    }
    validateSesi();

    function logout() { 
        Swal.fire({
            title: 'Keluar?',
            text: "Sesi Anda akan diakhiri",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#1B7548',
            confirmButtonText: 'Ya, Keluar'
        }).then((result) => {
            if (result.isConfirmed) {
                localStorage.clear(); 
                window.location.href = 'login.html'; 
            }
        });
    }

    // --- 2. FETCH DATA & AUTO REFRESH ---
    window.onload = () => {
        fetchData();
        setInterval(fetchData, 300000); 
    };

    async function fetchData() {
        const body = document.getElementById('tBody');
        if(body.innerHTML === "") {
             body.innerHTML = `<tr class="animate-pulse"><td colspan="7" class="p-10 text-center"><div class="flex flex-col items-center gap-2"><div class="h-4 bg-slate-100 rounded-full w-48"></div><div class="h-3 bg-slate-50 rounded-full w-32"></div></div></td></tr>`.repeat(4);
        }

        try {
            const res = await fetch(SCRIPT_URL + "?action=read");
            const result = await res.json(); 
            allData = result.iuran || []; 
            listSantri = result.santri || []; 

            renderTable(); 
            updateStats();
            updateCharts();
            populateSantriDropdown(); 
        } catch (e) {
            console.error(e);
            Swal.fire('Koneksi Gagal', 'Gagal memuat data dari Cloud.', 'error');
        }
    }

    // --- 3. LOGIKA OTOMATISASI FORM ---
    function populateSantriDropdown() {
        const selectNama = document.getElementById('f-nama');
        if(!selectNama) return;
        
        const currentVal = selectNama.value;
        selectNama.innerHTML = '<option value="">-- Pilih Nama Santri --</option>';
        
        listSantri.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.nama;
            opt.textContent = s.nama.toUpperCase();
            selectNama.appendChild(opt);
        });
        selectNama.value = currentVal;
    }

    // Helper Otomatis: Isi nominal saat bulan dipilih
    document.getElementById('f-bulan')?.addEventListener('change', function() {
        const nominalInp = document.getElementById('f-nominal');
        if(nominalInp && !nominalInp.value) nominalInp.value = TARGET_PER_BULAN;
    });

    // --- 4. RENDER TABLE (KONSISTEN + STYLING + SMART LINK) ---
    function renderTable() {
        const body = document.getElementById('tBody');
        body.innerHTML = '';
        
        allData.sort((a,b) => {
            const dateA = a.tanggal.split('/').reverse().join('-');
            const dateB = b.tanggal.split('/').reverse().join('-');
            return new Date(dateB) - new Date(dateA);
        }).forEach((item) => {
            const status = (item.status || "PENDING").toString().toUpperCase().trim();
            const isPending = status === "PENDING";
            
            // --- LOGIKA SMART LINK GOOGLE DRIVE ---
            let directLink = item.bukti;
            if (item.bukti && item.bukti.includes("drive.google.com")) {
                let fileId = "";
                if (item.bukti.includes("/d/")) {
                    fileId = item.bukti.split("/d/")[1].split("/")[0];
                } else if (item.bukti.includes("id=")) {
                    fileId = item.bukti.split("id=")[1].split("&")[0];
                }
                if (fileId) directLink = `https://lh3.googleusercontent.com/d/${fileId}`;
            }

            const tr = document.createElement('tr');
            tr.className = isPending ? "bg-amber-50/40 border-l-4 border-amber-400 animate-in fade-in duration-500" : "hover:bg-slate-50/50 border-b border-slate-100 transition-colors";
            
            tr.innerHTML = `
                <td class="px-6 py-4">
                    <button onclick="showDetailSantri('${item.nama}')" class="text-sm font-extrabold text-pnDark hover:text-pnGreen underline decoration-slate-200 decoration-2 underline-offset-4 transition-all">
                        ${item.nama}
                    </button>
                </td>
                <td class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-tighter">Iuran ${item.bulan}</td>
                <td class="px-6 py-4 text-sm font-black text-pnDark">
                    Rp ${Number(item.nominal).toLocaleString('id-ID')}
                </td>
                <td class="px-6 py-4 text-[10px] font-black text-slate-400">${item.tanggal}</td>
                <td class="px-6 py-4">
                    ${item.bukti && item.bukti.includes("http") ? 
                        `<a href="${directLink}" target="_blank" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase flex items-center gap-2 w-fit border border-blue-100 hover:bg-blue-600 hover:text-white transition-all">
                            <i class="fas fa-image"></i> LIHAT BUKTI
                        </a>` : `<span class="text-slate-300 italic text-[10px] font-bold">Tanpa Berkas</span>`
                    }
                </td>
                <td class="px-6 py-4 text-center">
                    <span class="px-3 py-1.5 rounded-lg text-[9px] font-black tracking-widest ${isPending ? 'bg-orange-100 text-orange-600 border-orange-200' : 'bg-green-100 text-green-700 border-green-200'} border">
                        ${status}
                    </span>
                </td>
                <td class="px-6 py-4 text-right space-x-2">
                    ${isPending ? 
                        `<button onclick="verifikasiIuranOtomatis('${item.id}', '${item.nama}', '${item.bulan}', '${item.nominal}', '${item.tanggal}')" class="bg-pnGreen text-white px-4 py-2 rounded-xl text-[10px] font-black hover:bg-pnDark shadow-lg shadow-pnGreen/20 transition-all uppercase">Konfirmasi</button>` :
                        `<button onclick="prosesKwitansi('${item.nama}', '${item.bulan}', '${item.nominal}', '${item.tanggal}')" title="Cetak Kwitansi" class="w-10 h-10 rounded-xl bg-slate-100 text-pnGreen hover:bg-pnGreen hover:text-white transition-all"><i class="fas fa-print"></i></button>`
                    }
                    <button onclick="hapusData('${item.id}')" title="Hapus Data" class="w-10 h-10 rounded-xl text-slate-200 hover:text-red-500 hover:bg-red-50 transition-all"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            body.appendChild(tr);
        });
    }

    // --- 5. UPDATE STATS & TARGET (KONSISTEN) ---
    function updateStats() {
        const dataValid = allData.filter(x => (x.status || "").toUpperCase() === "SUCCESS");
        const totalTerkumpul = dataValid.reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);
        
        const d = new Date();
        const currentMonth = d.getMonth() + 1;
        const currentYear = d.getFullYear();
        
        const nominalBulanIni = dataValid.filter(x => {
            const p = x.tanggal.split('/');
            return parseInt(p[1]) === currentMonth && parseInt(p[2]) === currentYear;
        }).reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);

        const totalAnggota = listSantri.length || 0;
        const targetBulanIni = totalAnggota * TARGET_PER_BULAN;
        const percent = targetBulanIni > 0 ? Math.round((nominalBulanIni / targetBulanIni) * 100) : 0;

        document.getElementById('stat-TotalMasuk').innerText = 'Rp ' + totalTerkumpul.toLocaleString('id-ID');
        document.getElementById('stat-BulanIni').innerText = 'Rp ' + nominalBulanIni.toLocaleString('id-ID');
        document.getElementById('stat-Saldo').innerText = 'Rp ' + totalTerkumpul.toLocaleString('id-ID');
        
        const elTarget = document.getElementById('total-santri-target');
        const elPercent = document.getElementById('target-percent');
        if(elTarget) elTarget.innerText = totalAnggota;
        if(elPercent) elPercent.innerText = percent + '%';
        
        const progressBar = document.getElementById('progress-bar-inner');
        if(progressBar) {
            setTimeout(() => {
                progressBar.style.width = Math.min(percent, 100) + '%';
                progressBar.className = percent >= 100 ? "h-full bg-blue-500 transition-all duration-1000" : "h-full bg-pnGreen transition-all duration-1000";
            }, 300);
        }
    }

    // --- 6. CHART PERTUMBUHAN (KONSISTEN) ---
    function updateCharts() {
        const chartEl = document.getElementById('pemasukanChart');
        if(!chartEl) return;
        const ctx = chartEl.getContext('2d');
        const bulanIndo = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        const labels = [];
        const dataValues = [];
        const d = new Date();

        for (let i = 5; i >= 0; i--) {
            let m = d.getMonth() - i;
            let y = d.getFullYear();
            if (m < 0) { m += 12; y -= 1; }
            labels.push(bulanIndo[m]);
            const total = allData.filter(x => {
                const p = x.tanggal.split('/');
                return parseInt(p[1]) === (m + 1) && parseInt(p[2]) === y && x.status === "SUCCESS";
            }).reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);
            dataValues.push(total);
        }

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pemasukan Kas',
                    data: dataValues,
                    borderColor: '#1B7548',
                    backgroundColor: 'rgba(27, 117, 72, 0.08)',
                    borderWidth: 4,
                    pointBackgroundColor: '#ffcc00',
                    pointBorderColor: '#fff',
                    pointRadius: 5,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 } } },
                    x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                }
            }
        });
    }

    // --- 7. GENERATE KWITANSI (KONSISTEN) ---
    async function prosesKwitansi(nama, bulan, nominal, tgl) {
        const profil = listSantri.find(s => s.nama.toLowerCase().trim() === nama.toLowerCase().trim());
        let noWA = profil ? profil.wa : "";

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: [100, 150] });
        
        // 1. Kotak Header Hijau
        doc.setFillColor(27, 117, 72); 
        doc.rect(0, 0, 100, 45, 'F'); 

        // 2. Logo (Direct googleusercontent Link)
        const logoUrl = "https://lh3.googleusercontent.com/d/1drM76LlU3sdqpwo-Urq7ZULoyORC0UMQ";
        try {
            doc.addImage(logoUrl, 'PNG', 40, 5, 20, 20);
        } catch (e) { console.error("Logo skip"); }

        doc.setTextColor(255, 255, 255); 
        doc.setFontSize(16); 
        doc.setFont("helvetica", "bold");
        doc.text("KWITANSI DIGITAL", 50, 35, { align: "center" });

        doc.setTextColor(40, 40, 40); 
        doc.setFontSize(9); 
        doc.text("PSNU PAGARNUSA UNUSIA", 50, 52, { align: "center" });

        doc.setLineWidth(0.5); 
        doc.line(15, 55, 85, 55);

        let yPos = 65;        
        const details = [
            ["Atas Nama", nama.toUpperCase()], 
            ["Jenis Bayar", "Iuran " + bulan], 
            ["Tanggal", tgl], 
            ["Nominal", "Rp " + Number(nominal).toLocaleString()], 
            ["Status", "TERVERIFIKASI"]
        ];
        
        details.forEach(row => { 
            doc.setFont("helvetica", "bold"); doc.setTextColor(120, 120, 120);
            doc.text(row[0], 15, yPos); 
            doc.setFont("helvetica", "bold"); doc.setTextColor(27, 117, 72);
            doc.text(": " + row[1], 40, yPos); 
            yPos += 10; 
        });

        doc.setTextColor(180, 180, 180); doc.setFontSize(7);
        doc.text("Kwitansi ini sah diterbitkan oleh bendahara rayon UNUSIA.", 50, 140, { align: "center" });

        doc.save(`Kwitansi_${nama.replace(/\s+/g, '_')}.pdf`);

        if(noWA) {
            let cleanWA = noWA.toString().replace(/\D/g, '');
            if (cleanWA.startsWith('0')) cleanWA = '62' + cleanWA.slice(1);
            const msg = `*BUKTI PEMBAYARAN IURAN*%0A%0AAtas Nama: *${nama}*%0ABulan: *${bulan}*%0ANominal: *Rp ${Number(nominal).toLocaleString()}*%0AStatus: *TERVERIFIKASI*%0A%0A_Kwitansi PDF telah diterbitkan secara otomatis oleh sistem._`;
            window.open(`https://wa.me/${cleanWA}?text=${msg}`, '_blank');
        }
    }

    // --- 8. CRUD OPERATIONS (KONSISTEN) ---
    async function verifikasiIuranOtomatis(id, nama, bulan, nominal, tgl) {
        const res = await Swal.fire({ 
            title: 'Verifikasi?', 
            text: `Konfirmasi pembayaran ${nama} & cetak kwitansi?`, 
            icon: 'question', 
            showCancelButton: true, 
            confirmButtonText: 'Ya, Proses!',
            confirmButtonColor: '#1B7548' 
        });
        
        if(res.isConfirmed) {
            Swal.fire({ title: 'Memperbarui Cloud...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'updateStatus', id: id, status: 'SUCCESS' }) });
                await fetchData();
                await prosesKwitansi(nama, bulan, nominal, tgl);
                Swal.fire('Berhasil', 'Status SUCCESS & Kwitansi Terkirim.', 'success');
            } catch (e) {
                Swal.fire('Gagal', 'Terjadi gangguan koneksi.', 'error');
            }
        }
    }

    async function hapusData(id) {
        const res = await Swal.fire({ 
            title: 'Hapus Data?', 
            text: "Data akan hilang permanen!", 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'Ya, Hapus'
        });
        
        if(res.isConfirmed) {
            Swal.fire({ title: 'Menghapus...', didOpen: () => Swal.showLoading() });
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id }) });
                fetchData();
                Swal.fire('Terhapus', 'Data berhasil dibuang.', 'success');
            } catch(e) {
                Swal.fire('Gagal', 'Gagal terhubung ke server.', 'error');
            }
        }
    }

    // --- 9. FORM SUBMISSION ---
    document.getElementById('iuranForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerHTML = "<i class='fas fa-circle-notch animate-spin'></i> Menyimpan...";
        
        const payload = { 
            id: "TRX-" + Date.now(), 
            date: document.getElementById('f-tgl').value, 
            v1: document.getElementById('f-nama').value, 
            v2: document.getElementById('f-bulan').value, 
            v3: document.getElementById('f-nominal').value, 
            status: "SUCCESS" 
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'insert', data: payload }) });
            closeModal(); 
            fetchData(); 
            Swal.fire('Tersimpan', 'Data iuran berhasil ditambahkan.', 'success');
        } catch(e) {
            Swal.fire('Gagal', 'Gagal menyimpan data.', 'error');
        } finally {
            btn.disabled = false; btn.innerHTML = "Konfirmasi & Simpan";
        }
    };

    // --- 10. UI HELPERS ---
    function filterData(q) {
        const rows = document.querySelectorAll('#tBody tr');
        rows.forEach(r => {
            const match = r.innerText.toLowerCase().includes(q.toLowerCase());
            r.style.display = match ? '' : 'none';
            if(match && q !== "") r.classList.add('bg-yellow-50'); else r.classList.remove('bg-yellow-50');
        });
    }

    function openModal() { 
        document.getElementById('modal').classList.remove('hidden'); 
        const tglInp = document.getElementById('f-tgl');
        if(tglInp) tglInp.valueAsDate = new Date(); 
    }
    
    function closeModal() { 
        document.getElementById('modal').classList.add('hidden'); 
        document.getElementById('iuranForm').reset(); 
    }

    function showDetailSantri(nama) {
        const riwayat = allData.filter(x => x.nama.toLowerCase().trim() === nama.toLowerCase().trim() && x.status === "SUCCESS");
        const total = riwayat.reduce((acc, curr) => acc + (Number(curr.nominal) || 0), 0);
        Swal.fire({
            title: `<span class="text-pnGreen">${nama.toUpperCase()}</span>`,
            html: `
                <div class="p-4 bg-slate-50 rounded-2xl text-left space-y-3 border border-slate-100">
                    <div class="flex justify-between border-b border-slate-200 pb-2">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Kontribusi</span>
                        <b class="text-pnDark">Rp ${total.toLocaleString('id-ID')}</b>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Jumlah Transaksi</span>
                        <b class="text-pnDark">${riwayat.length} Kali</b>
                    </div>
                </div>`,
            confirmButtonColor: '#1B7548',
            confirmButtonText: 'Tutup'
        });
    }

async function generateMonthlyReport() {
        const { jsPDF } = window.jspdf; 
        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });

        // 1. DATA & WAKTU (Otomatis & Konsisten)
        const d = new Date(); 
        const m = d.getMonth() + 1; 
        const y = d.getFullYear();
        const pageWidth = doc.internal.pageSize.getWidth(); 
        const pageHeight = doc.internal.pageSize.getHeight();
        
        // MARGIN PRESISI (Kiri 3cm, Kanan 3cm, Atas 1cm, Bawah 1cm)
        const margin = { left: 30, right: 30, top: 10, bottom: 10 };
        const centerX = pageWidth / 2;

        // 2. HEADER / KOP RESMI (Full Otomatis)
        const logoUrl = "https://lh3.googleusercontent.com/d/1drM76LlU3sdqpwo-Urq7ZULoyORC0UMQ";
        try {
            doc.addImage(logoUrl, 'PNG', centerX - 11, margin.top, 22, 22);
        } catch (e) { console.error("Logo error:", e); }

        doc.setFont("helvetica", "bold");
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text("PIMPINAN RAYON", centerX, margin.top + 28, { align: "center" });
        
        doc.setFontSize(15);
        doc.setTextColor(27, 117, 72); // Hijau Khas Pagar Nusa
        doc.text("PSNU PAGAR NUSA UNUSIA", centerX, margin.top + 34, { align: "center" });

        // Garis Pembatas KOP (Professional Look)
        doc.setLineWidth(0.8);
        doc.setDrawColor(0, 0, 0);
        doc.line(margin.left, margin.top + 38, pageWidth - margin.right, margin.top + 38);
        doc.setLineWidth(0.2);
        doc.line(margin.left, margin.top + 39.5, pageWidth - margin.right, margin.top + 39.5);

        // 3. LOGIKA FILTER DATA (Mengambil SEMUA data SUCCESS agar tidak terpotong)
        const dataLaporan = allData.filter(x => (x.status || "").toUpperCase() === "SUCCESS");

        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.setFont("helvetica", "bold");
        doc.text(`Laporan Keuangan: Rekapitulasi Kas Keseluruhan`, margin.left, margin.top + 48);
        
        doc.setFont("helvetica", "normal");
        const tglCetak = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
        doc.text(`Tanggal Cetak: ${tglCetak}`, pageWidth - margin.right, margin.top + 48, { align: "right" });

        // 4. TRANSFORMASI DATA KE TABEL
        const rows = dataLaporan.map((item, i) => [
            i + 1, 
            item.nama.toUpperCase(), 
            item.bulan, 
            item.tanggal, 
            `Rp ${Number(item.nominal).toLocaleString('id-ID')}`
        ]);

        const totalPenerimaan = dataLaporan.reduce((a, b) => a + Number(b.nominal), 0);

        // GENERATE TABEL
        doc.autoTable({
            head: [['NO', 'NAMA SANTRI', 'BULAN', 'TANGGAL', 'NOMINAL']],
            body: rows,
            startY: margin.top + 53,
            margin: { left: margin.left, right: margin.right },
            headStyles: { 
                fillColor: [27, 117, 72], 
                halign: 'center', 
                fontStyle: 'bold',
                fontSize: 9
            },
            columnStyles: { 
                0: { halign: 'center', cellWidth: 10 }, 
                4: { halign: 'right' } 
            },
            // FOOTER TABEL (Total ditaruh paling akhir sekali)
            foot: [['', '', '', 'TOTAL PENERIMAAN', `Rp ${totalPenerimaan.toLocaleString('id-ID')}`]],
            showFoot: 'lastPage', // FITUR BARU: Total hanya muncul di akhir tabel saja
            footStyles: { 
                fillColor: [240, 240, 240], 
                textColor: [0, 0, 0], 
                fontStyle: 'bold', 
                halign: 'right' 
            },
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2.5 }
        });

        // 5. AREA TANDA TANGAN (Otomatis menyesuaikan posisi tabel)
        let ySign = doc.lastAutoTable.finalY + 15;
        
        // Proteksi Halaman Baru: Jika ruang tanda tangan tidak cukup (muat di bawah 55mm)
        if (ySign + 55 > pageHeight) {
            doc.addPage();
            ySign = 20;
        }

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Mengetahui,", centerX, ySign, { align: "center" });

        // Tanda Tangan Ketua Umum (Kiri)
        const leftCol = margin.left + 25;
        doc.text("Ketua Umum,", leftCol, ySign + 10, { align: "center" });
        try {
            const ttdKetua = "https://lh3.googleusercontent.com/d/1yCu3bQc69uXpJSUpK-W3nuX0ukzbXYLg"; 
            doc.addImage(ttdKetua, 'PNG', leftCol - 15, ySign + 12, 30, 15);
        } catch(e) {}
        doc.setFont("helvetica", "bold");
        doc.text("ILHAM IQYANUDDIN", leftCol, ySign + 35, { align: "center" });
        doc.setFont("helvetica", "normal");
        doc.text("NIA. 27091985", leftCol, ySign + 40, { align: "center" });

        // Tanda Tangan Bendahara Umum (Kanan)
        const rightCol = pageWidth - margin.right - 25;
        doc.text("Bendahara Umum,", rightCol, ySign + 10, { align: "center" });
        try {
            const ttdBendahara = "https://lh3.googleusercontent.com/d/1_1sFSL8g98RTrgm6YJLpgduzbHyQP_iJ"; 
            doc.addImage(ttdBendahara, 'PNG', rightCol - 15, ySign + 12, 30, 15);
        } catch(e) {}
        doc.setFont("helvetica", "bold");
        doc.text("SYIFA ULYA SETIAWAN", rightCol, ySign + 35, { align: "center" });
        doc.setFont("helvetica", "normal");
        doc.text("NIA. 03011986", rightCol, ySign + 40, { align: "center" });

        // 6. FOOTER HALAMAN DIGITAL
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text("Dicetak melalui Sistem Digital Brankas Pagar Nusa Unusia", centerX, pageHeight - 5, { align: "center" });

        // Simpan File
        doc.save(`Laporan_Keuangan_${m}_${y}.pdf`);
    }
</script>
</body>
</html>