<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi Terpadu | PAGARNUSA</title>
    <link rel="icon" type="image/png" href="logopn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #1B7548;
            --primary-dark: #145a38;
            --accent: #fbbf24;
        }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: radial-gradient(circle at top right, #f0fdf4, #f8fafc);
            color: #1e293b;
            min-height: 100vh;
            user-select: none;
        }
        .glass { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.5); 
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.05);
        }
        .page { display: none; width: 100%; max-width: 28rem; margin: auto; animation: fadeInUp 0.5s ease-out forwards; }
        .page.active { display: block; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .opt-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e2e8f0;
        }
        .opt-btn:hover { 
            border-color: var(--primary);
            transform: translateX(5px);
            background: white;
        }
        
        .loader { border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .check-card input:checked + .card-content {
            background: linear-gradient(to right, #ecfdf5, #f0fdf4);
            border-color: var(--primary);
        }
        .check-card input:checked + .card-content .check-icon {
            background-color: var(--primary);
            border-color: var(--primary);
        }
    </style>
</head>
<body class="p-4 flex flex-col justify-start items-center">

    <div id="page-kampus" class="page active">
        <div class="text-center mt-10 mb-10">
            <img src="logopn.png" alt="Logo" class="w-24 h-24 mx-auto mb-6 drop-shadow-lg animate-bounce">
            <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">E-<span class="text-emerald-600">Absensi</span></h1>
            <p class="text-slate-500 font-medium mt-1 uppercase text-[10px] tracking-[0.3em]">PAGARNUSA UNUSIA</p>
        </div>
        
        <div class="space-y-4">
            <button onclick="navToPelet('Jakarta')" class="opt-btn w-full glass p-6 rounded-[2.5rem] flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-700 shadow-inner">
                        <i class="fas fa-city text-xl"></i>
                    </div>
                    <span class="text-xl font-bold text-slate-700">JAKARTA</span>
                </div>
                <i class="fas fa-arrow-right text-slate-300 group-hover:text-emerald-600 transition-colors"></i>
            </button>

            <button onclick="navToPelet('Bogor')" class="opt-btn w-full glass p-6 rounded-[2.5rem] flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-700 shadow-inner">
                        <i class="fas fa-mountain-sun text-xl"></i>
                    </div>
                    <span class="text-xl font-bold text-slate-700">BOGOR</span>
                </div>
                <i class="fas fa-arrow-right text-slate-300 group-hover:text-emerald-600 transition-colors"></i>
            </button>
        </div>
    </div>

    <div id="page-pelet" class="page">
        <div class="flex items-center gap-4 mt-6 mb-8">
            <button onclick="showPage('page-kampus')" class="w-12 h-12 glass rounded-2xl flex items-center justify-center text-slate-400 hover:text-emerald-600 transition-all active:scale-90">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div>
                <h2 id="display-kampus" class="text-xl font-black text-slate-800 uppercase italic">KAMPUS</h2>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Pilih Tingkatan Pelet</p>
            </div>
        </div>

        <div id="pelet-list" class="space-y-6">
            </div>
    </div>

    <div id="page-daftar" class="page !max-w-2xl">
        <header class="glass p-5 rounded-3xl flex justify-between items-center mb-6 mt-4 sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <button onclick="showPage('page-pelet')" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-emerald-600 transition-colors">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div>
                    <p id="display-info" class="text-[10px] font-black text-emerald-600 uppercase tracking-tighter">Pelet Putih</p>
                    <h2 class="font-extrabold text-slate-800 leading-none">Kehadiran</h2>
                </div>
            </div>
            <div class="bg-emerald-600 text-white px-4 py-2 rounded-2xl text-xs font-bold shadow-lg shadow-emerald-200">
                <span id="check-count">0</span> Terpilih
            </div>
        </header>

        <div class="glass p-5 rounded-[2rem] mb-6 flex items-center justify-between border-l-4 border-l-emerald-500 shadow-sm">
            <div class="flex items-center gap-4">
                <div class="bg-emerald-50 w-12 h-12 rounded-2xl flex items-center justify-center text-emerald-600 shadow-sm">
                    <i class="fas fa-clock"></i>
                </div>
                <div>
                    <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Waktu Presensi</p>
                    <p id="auto-time" class="font-bold text-slate-700 text-sm">Memuat waktu...</p>
                </div>
            </div>
            <div class="text-right">
                <p id="auto-day" class="text-xs font-black text-emerald-700 uppercase italic bg-emerald-50 px-3 py-1 rounded-lg"></p>
            </div>
        </div>

        <div id="loading" class="hidden py-10 text-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mx-auto mb-4"></div>
            <p class="text-xs font-bold text-slate-400 animate-pulse uppercase tracking-widest">Sinkronisasi Server...</p>
        </div>

        <div id="santri-grid" class="grid grid-cols-1 gap-3 mb-28">
            </div>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-md px-6">
            <button id="btn-submit" onclick="submitAbsen()" class="w-full py-5 bg-slate-900 hover:bg-emerald-800 text-white font-bold rounded-[2rem] shadow-2xl transition-all active:scale-95 flex items-center justify-center gap-3 group overflow-hidden relative">
                <span class="relative z-10 uppercase tracking-wider">Simpan Absensi</span>
                <i class="fas fa-cloud-arrow-up relative z-10 opacity-50 group-hover:opacity-100 transition-opacity"></i>
            </button>
        </div>
    </div>

    <script>
        const CONFIG = {
            API: "https://script.google.com/macros/s/AKfycbw4JRpC7MC_j6_grznsTCXJfTDYXDHB5mM24ArR4hnQmA_O-D_pwmAw0agM0whwmk2N/exec ", // GANTI DENGAN URL ANDA
            MENU: {
                "MUDA": ["Putih", "Kuning", "Merah"],
                "MADYA": ["Biru", "Coklat", "Hitam"]
            }
        };

        let state = {
            kampus: '',
            tingkat: '',
            pelet: '',
            data: []
        };

        // Live Clock Function
        function updateLiveClock() {
            const now = new Date();
            const opsiHari = { weekday: 'long' };
            const opsiTanggal = { day: '2-digit', month: 'long', year: 'numeric' };
            
            const hari = now.toLocaleDateString('id-ID', opsiHari);
            const tanggal = now.toLocaleDateString('id-ID', opsiTanggal);
            const jam = now.getHours().toString().padStart(2, '0');
            const menit = now.getMinutes().toString().padStart(2, '0');
            const detik = now.getSeconds().toString().padStart(2, '0');

            if(document.getElementById('auto-time')) {
                document.getElementById('auto-time').innerText = `${tanggal} • ${jam}:${menit}:${detik}`;
                document.getElementById('auto-day').innerText = hari;
            }
        }
        setInterval(updateLiveClock, 1000);

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);
        }

        function navToPelet(k) {
            state.kampus = k;
            document.getElementById('display-kampus').innerText = "KAMPUS " + k;
            renderPeletMenu();
            showPage('page-pelet');
        }

        function renderPeletMenu() {
            const container = document.getElementById('pelet-list');
            container.innerHTML = '';
            
            for (const [tingkat, warnaList] of Object.entries(CONFIG.MENU)) {
                let html = `<div class="mb-4"><h3 class="text-[10px] font-black text-slate-400 tracking-[0.2em] mb-4 ml-2 uppercase">${tingkat}</h3>`;
                warnaList.forEach(warna => {
                    html += `
                        <button onclick="navToDaftar('${tingkat}', '${warna}')" class="opt-btn w-full bg-white p-5 rounded-[1.8rem] flex items-center justify-between shadow-sm mb-3 group">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-8 rounded-full bg-emerald-500"></div>
                                <span class="font-bold text-slate-700 italic text-lg">Pelet ${warna}</span>
                            </div>
                            <i class="fas fa-chevron-right text-slate-200 group-hover:text-emerald-500 transition-colors"></i>
                        </button>
                    `;
                });
                html += `</div>`;
                container.innerHTML += html;
            }
        }

        async function navToDaftar(t, p) {
            state.tingkat = t;
            state.pelet = p;
            document.getElementById('display-info').innerText = `${t} • PELET ${p}`;
            showPage('page-daftar');
            
            if(state.data.length === 0) {
                await fetchSantri();
            }
            renderSantri();
        }

        async function fetchSantri() {
            const loading = document.getElementById('loading');
            loading.classList.remove('hidden');
            try {
                const res = await fetch(CONFIG.API);
                state.data = await res.json();
            } catch (e) {
                console.error("Fetch error:", e);
                alert("Gagal memuat data dari database.");
            } finally {
                loading.classList.add('hidden');
            }
        }

        function renderSantri() {
            const grid = document.getElementById('santri-grid');
            const filtered = state.data.filter(s => s.Kampus === state.kampus && s.Pelet === state.pelet);
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div class="text-center py-20 glass rounded-[2rem]"><i class="fas fa-user-slash text-4xl text-slate-200 mb-4 block"></i><p class="text-slate-400 font-bold text-sm">Tidak ada data santri.</p></div>`;
                return;
            }

            grid.innerHTML = filtered.map(s => `
                <label class="check-card cursor-pointer block">
                    <input type="checkbox" value="${s.Nama}" class="hidden" onchange="updateUI()">
                    <div class="card-content glass p-5 rounded-[1.5rem] border-2 border-transparent transition-all flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold text-xs uppercase">
                                ${s.Nama.substring(0,2)}
                            </div>
                            <span class="font-bold text-slate-700 text-sm uppercase tracking-tight">${s.Nama}</span>
                        </div>
                        <div class="w-6 h-6 rounded-lg border-2 border-slate-200 flex items-center justify-center text-[10px] text-white check-icon transition-all">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </label>
            `).join('');
        }

        function updateUI() {
            const checked = document.querySelectorAll('#santri-grid input:checked').length;
            document.getElementById('check-count').innerText = checked;
        }

        async function submitAbsen() {
            const hadir = Array.from(document.querySelectorAll('#santri-grid input:checked')).map(cb => cb.value);
            if(hadir.length === 0) return alert("Pilih minimal satu santri!");

            const btn = document.getElementById('btn-submit');
            const now = new Date();
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> MEMPROSES DATA...`;

            const payload = {
                timestamp: now.toISOString(),
                hari: now.toLocaleDateString('id-ID', { weekday: 'long' }),
                tanggal: now.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                jam: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                kampus: state.kampus,
                pelet: state.pelet,
                hadir: hadir.join(", ")
            };

            try {
                await fetch(CONFIG.API, { 
                    method: 'POST', 
                    mode: 'no-cors',
                    body: JSON.stringify(payload) 
                });
                alert("✅ ABSENSI BERHASIL DISIMPAN!");
                location.reload();
            } catch (e) {
                alert("Gagal mengirim data. Periksa koneksi internet.");
                btn.disabled = false;
                btn.innerHTML = `SIMPAN ABSENSI <i class="fas fa-cloud-arrow-up"></i>`;
            }
        }
    </script>
</body>
</html>