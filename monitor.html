<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Pantu | PAGARNUSA UNUSIA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#1B7548', primaryDark: '#145c38' } } }
        }
    </script>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .status-badge { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .notification-toast {
            position: fixed; top: 80px; right: 20px; z-index: 1000;
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .progress-bar-fill { transition: width 1s ease-in-out; }

        /* Score Coloring */
        .score-low { background-color: #ef4444 !important; color: white !important; }
        .score-mid { background-color: #f59e0b !important; color: white !important; }
        .score-high { background-color: #10b981 !important; color: white !important; }
    </style>
</head>
<body class="pb-10 min-h-screen">
    <div id="notification-area"></div>

<nav class="bg-primary text-white shadow-lg sticky top-0 z-50 backdrop-blur-md bg-opacity-95 border-b border-emerald-800/30">
        <div class="max-w-6xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-lg transform -rotate-3 border-2 border-emerald-100">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo_Pagar_Nusa.png/600px-Logo_Pagar_Nusa.png" 
                                 alt="Logo" class="w-10 h-10 object-contain">
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-400 border-2 border-primary rounded-full animate-pulse"></div>
                    </div>
                    
                    <div class="flex flex-col">
                        <h1 class="font-black text-sm md:text-lg tracking-tight leading-none">PANTU MONITORING</h1>
                        <p class="text-[10px] md:text-xs text-emerald-200 font-medium tracking-[0.15em] uppercase opacity-80">Pagar Nusa UNUSIA</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 md:gap-6">
                    <div class="hidden sm:flex flex-col items-end pr-4 border-r border-white/10">
                        <div id="digital-clock" class="font-black text-xl tracking-tighter leading-none text-white">
                            00:00<span class="text-emerald-400 text-sm ml-1">:00</span>
                        </div>
                        <div id="current-date" class="text-[9px] font-bold text-emerald-200 uppercase tracking-widest">
                            Loading date...
                        </div>
                    </div>

                    <div class="flex flex-col items-center gap-1">
                        <div id="conn-status" class="flex items-center gap-2 bg-black/20 px-3 py-1.5 rounded-xl border border-white/10 shadow-inner">
                            <div id="status-dot" class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                            <span id="status-text" class="text-[10px] font-black tracking-widest uppercase">Live</span>
                        </div>
                        <span id="last-update" class="text-[8px] text-emerald-300 font-medium italic">Syncing...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 pt-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-card p-5 rounded-[2rem]">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider">Total Peserta</p>
                <p id="stat-total" class="text-2xl font-black text-slate-800">0</p>
            </div>
            <div class="glass-card p-5 rounded-[2rem] border-l-4 border-l-primary">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider">Lulus Semua Pos</p>
                <p id="stat-done" class="text-2xl font-black text-primary">0</p>
            </div>
            <div class="col-span-2 glass-card p-5 rounded-[2rem]">
                <div class="flex justify-between items-end mb-2">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Global Progress</p>
                    <span id="stat-percent" class="text-xs font-bold text-primary">0%</span>
                </div>
                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden border border-slate-50">
                    <div id="global-progress" class="progress-bar-fill bg-gradient-to-r from-emerald-500 to-primary h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="sticky top-[80px] z-40 mb-6 flex flex-col md:flex-row gap-3">
            <div class="flex-1 relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                <input type="text" id="search-input" oninput="applyFilters()" placeholder="Cari nama peserta..." 
                    class="w-full pl-10 pr-4 py-3 rounded-2xl glass-card focus:outline-none focus:ring-2 focus:ring-primary/30 text-sm">
            </div>
            <select id="filter-kelompok" onchange="applyFilters()" 
                class="bg-white px-4 py-3 rounded-2xl glass-card focus:outline-none text-sm font-bold text-slate-600">
                <option value="all">Semua Kelompok</option>
            </select>
            <button onclick="fetchData()" class="bg-primary text-white px-6 py-3 rounded-2xl font-bold text-sm hover:bg-primaryDark transition-all shadow-lg shadow-emerald-900/20">
                <i class="fas fa-sync-alt mr-2" id="refresh-icon"></i> Refresh
            </button>
        </div>

        <div id="kelompok-container" class="space-y-8">
            <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                <div class="w-12 h-12 border-4 border-slate-200 border-t-primary rounded-full animate-spin mb-4"></div>
                <p class="text-xs font-bold uppercase tracking-widest">Memuat Data...</p>
            </div>
        </div>
    </main>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyj9RdmXWoSUJ1wvwAquHwfiFvUHTBww_6JeJjGjQKCc4bvcReUfNW2B5c7idBZW_8p/exec";
        let MASTER_DATA = [];
        let PREVIOUS_DATA = null;

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function updateOnlineStatus() {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if(navigator.onLine) {
                dot.classList.replace('bg-red-500', 'bg-emerald-400');
                if(txt) txt.innerText = "Online";
                fetchData();
            } else {
                dot.classList.replace('bg-emerald-400', 'bg-red-500');
                if(txt) txt.innerText = "Offline";
            }
        }

        function showNotification(nama, pos) {
            const area = document.getElementById('notification-area');
            const id = Date.now();
            const toast = `
                <div id="toast-${id}" class="notification-toast bg-white shadow-2xl rounded-2xl p-4 border-l-4 border-primary flex items-center gap-4 mb-3 min-w-[280px]">
                    <div class="w-10 h-10 bg-emerald-100 text-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-bell text-lg"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-800">${nama}</p>
                        <p class="text-[10px] text-slate-500">Update di Pos <b class="text-primary">${pos}</b></p>
                    </div>
                </div>
            `;
            area.insertAdjacentHTML('beforeend', toast);
            setTimeout(() => { document.getElementById(`toast-${id}`)?.remove(); }, 4000);
        }

        async function fetchData() {
            if (!navigator.onLine) return;
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('fa-spin');
            
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (PREVIOUS_DATA) checkNewValues(PREVIOUS_DATA, data);
                PREVIOUS_DATA = data;
                MASTER_DATA = data;

                updateGlobalStats(data);
                populateGroupFilter(data);
                applyFilters();

                document.getElementById('last-update').innerText = "Live: " + new Date().toLocaleTimeString('id-ID');
            } catch (error) {
                console.error("Fetch Error:", error);
            } finally {
                refreshIcon.classList.remove('fa-spin');
            }
        }

        function checkNewValues(oldData, newData) {
            newData.forEach((newItem) => {
                const oldItem = oldData.find(o => o.nama === newItem.nama);
                if(!oldItem) return;
                ['fisik', 'teknik', 'mental', 'jurus', 'kebangsaan', 'nu', 'pn'].forEach(pos => {
                    if (newItem[pos] && !oldItem[pos]) showNotification(newItem.nama, pos.toUpperCase());
                });
            });
        }

        function populateGroupFilter(data) {
            const select = document.getElementById('filter-kelompok');
            const groups = [...new Set(data.map(item => item.kelompok))].filter(g => g).sort((a,b) => a-b);
            const currentVal = select.value;
            select.innerHTML = '<option value="all">Semua Kelompok</option>';
            groups.forEach(g => {
                select.innerHTML += `<option value="${g}">Kelompok ${g}</option>`;
            });
            select.value = currentVal;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const groupFilter = document.getElementById('filter-kelompok').value;

            const filtered = MASTER_DATA.filter(item => {
                const matchSearch = item.nama.toLowerCase().includes(searchTerm);
                const matchGroup = groupFilter === 'all' || String(item.kelompok) === groupFilter;
                return matchSearch && matchGroup;
            });

            const grouped = filtered.reduce((acc, curr) => {
                const klp = curr.kelompok || "Umum";
                if (!acc[klp]) acc[klp] = [];
                acc[klp].push(curr);
                return acc;
            }, {});

            renderDashboard(grouped);
        }

        function updateGlobalStats(data) {
            const total = data.length;
            const finished = data.filter(m => m.fisik && m.teknik && m.mental && m.jurus && m.kebangsaan && m.nu && m.pn).length;
            const percent = Math.round((finished / total * 100)) || 0;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-done').innerText = finished;
            document.getElementById('stat-percent').innerText = percent + '%';
            document.getElementById('global-progress').style.width = percent + '%';
        }

        function renderDashboard(grouped) {
            const container = document.getElementById('kelompok-container');
            container.innerHTML = '';

            const sortedGroups = Object.keys(grouped).sort((a, b) => a - b);
            
            if(sortedGroups.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">Data tidak ditemukan...</div>`;
                return;
            }

            sortedGroups.forEach(klp => {
                const members = grouped[klp];
                const groupProgress = calculateGroupProgress(members);
                
                let groupHtml = `
                    <div class="glass-card rounded-[2.5rem] overflow-hidden border border-slate-100 mb-6">
                        <div class="bg-primary/5 px-6 py-4 flex justify-between items-center border-b border-slate-100">
                            <div>
                                <h2 class="font-black text-slate-800 uppercase">KELOMPOK ${klp}</h2>
                                <p class="text-[9px] text-primary font-bold tracking-widest uppercase">Progress Kelompok</p>
                            </div>
                            <span class="bg-primary text-white text-[10px] px-3 py-1 rounded-full font-bold">${groupProgress}%</span>
                        </div>
                        <div class="overflow-x-auto no-scrollbar">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50 text-[9px] uppercase font-bold text-slate-400">
                                    <tr>
                                        <th class="px-6 py-4 min-w-[150px]">Nama</th>
                                        <th class="px-2 py-4 text-center">FIS</th>
                                        <th class="px-2 py-4 text-center">TEK</th>
                                        <th class="px-2 py-4 text-center">MEN</th>
                                        <th class="px-2 py-4 text-center">JUR</th>
                                        <th class="px-2 py-4 text-center">KBN</th>
                                        <th class="px-2 py-4 text-center">NU</th>
                                        <th class="px-2 py-4 text-center">PN</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                `;

                members.forEach(m => {
                    groupHtml += `
                        <tr class="hover:bg-emerald-50/30">
                            <td class="px-6 py-4 text-[11px] font-bold text-slate-700">${m.nama}</td>
                            ${renderStatusCell(m.fisik)}
                            ${renderStatusCell(m.teknik)}
                            ${renderStatusCell(m.mental)}
                            ${renderStatusCell(m.jurus)}
                            ${renderStatusCell(m.kebangsaan)}
                            ${renderStatusCell(m.nu)}
                            ${renderStatusCell(m.pn)}
                        </tr>
                    `;
                });

                groupHtml += `</tbody></table></div></div>`;
                container.innerHTML += groupHtml;
            });
        }

        function renderStatusCell(val) {
            const score = parseInt(val);
            let colorClass = 'bg-slate-50 text-slate-200';
            
            if (!isNaN(score)) {
                if (score < 75) colorClass = 'score-low';
                else if (score < 85) colorClass = 'score-mid';
                else colorClass = 'score-high';
            }

            const isDone = val !== "" && val !== null && val !== undefined;
            return `
                <td class="px-2 py-3 text-center">
                    <div class="w-8 h-8 mx-auto rounded-xl flex items-center justify-center text-[10px] font-black status-badge ${colorClass} ${isDone ? 'shadow-md border border-white/20' : 'border border-slate-100'}">
                        ${isDone ? val : '<i class="fas fa-minus opacity-20"></i>'}
                    </div>
                </td>
            `;
        }

        function calculateGroupProgress(members) {
            let totalPossible = members.length * 7;
            let current = 0;
            members.forEach(m => {
                ['fisik', 'teknik', 'mental', 'jurus', 'kebangsaan', 'nu', 'pn'].forEach(k => { if(m[k]) current++; });
            });
            return Math.round((current / totalPossible) * 100) || 0;
        }

        // Init
        updateOnlineStatus();
        setInterval(fetchData, 10000); 
    </script>
</body>
</html>

