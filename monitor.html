<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Pantu | PAGARNUSA UNUSIA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#1B7548', primaryDark: '#145c38' } } }
        }
    </script>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .status-badge { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .notification-toast {
            position: fixed; top: 80px; right: 20px; z-index: 1000;
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Mobile Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .progress-bar-fill { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="pb-10 min-h-screen">
    <div id="notification-area"></div>

    <nav class="bg-primary text-white p-4 shadow-lg sticky top-0 z-50 backdrop-blur-md bg-opacity-90">
        <div class="flex items-center justify-between max-w-6xl mx-auto">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-inner">
                    <i class="fas fa-chart-line text-primary text-xl"></i>
                </div>
                <div class="flex flex-col leading-tight">
                    <span class="font-bold text-[11px] tracking-wider uppercase">Operator Sistem</span>
                    <span id="last-update" class="font-medium text-[9px] text-emerald-200 tracking-wider">Sinkronisasi...</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="conn-status" class="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full border border-white/20">
                    <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                    <span class="text-[9px] font-bold tracking-widest uppercase">Live</span>
                </div>
                <button onclick="fetchData()" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded-full transition-all">
                    <i class="fas fa-sync-alt text-sm" id="refresh-icon"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 pt-6">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-card p-5 rounded-[2rem]">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider">Total Peserta</p>
                <p id="stat-total" class="text-2xl font-black text-slate-800">0</p>
            </div>
            <div class="glass-card p-5 rounded-[2rem] border-l-4 border-l-primary">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider">Lulus Semua Pos</p>
                <p id="stat-done" class="text-2xl font-black text-primary">0</p>
            </div>
            <div class="col-span-2 glass-card p-5 rounded-[2rem]">
                <div class="flex justify-between items-end mb-2">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Global Progress</p>
                    <span id="stat-percent" class="text-xs font-bold text-primary">0%</span>
                </div>
                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden border border-slate-50">
                    <div id="global-progress" class="progress-bar-fill bg-gradient-to-r from-emerald-500 to-primary h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="kelompok-container" class="space-y-8">
            <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                <div class="w-12 h-12 border-4 border-slate-200 border-t-primary rounded-full animate-spin mb-4"></div>
                <p class="text-xs font-bold uppercase tracking-widest">Menghubungkan Data...</p>
            </div>
        </div>
    </main>

    <script>
        // GANTI DENGAN URL SCRIPT GOOGLE ANDA
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyj9RdmXWoSUJ1wvwAquHwfiFvUHTBww_6JeJjGjQKCc4bvcReUfNW2B5c7idBZW_8p/exec";
        let PREVIOUS_DATA = null;

        function showNotification(nama, pos) {
            const area = document.getElementById('notification-area');
            const id = Date.now();
            const toast = `
                <div id="toast-${id}" class="notification-toast bg-white shadow-2xl rounded-2xl p-4 border-l-4 border-primary flex items-center gap-4 mb-3 min-w-[280px]">
                    <div class="w-10 h-10 bg-emerald-100 text-primary rounded-full flex items-center justify-center">
                        <i class="fas fa-check-double text-lg"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-800">${nama}</p>
                        <p class="text-[10px] text-slate-500">Nilai Pos <b class="text-primary">${pos}</b> telah masuk!</p>
                    </div>
                </div>
            `;
            area.insertAdjacentHTML('beforeend', toast);
            setTimeout(() => {
                const el = document.getElementById(`toast-${id}`);
                if(el) {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(20px)';
                    setTimeout(() => el.remove(), 500);
                }
            }, 4000);
        }

        async function fetchData() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('fa-spin');
            
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if (PREVIOUS_DATA) {
                    checkNewValues(PREVIOUS_DATA, data);
                }
                PREVIOUS_DATA = data;

                const grouped = data.reduce((acc, curr) => {
                    const klp = curr.kelompok || "Umum";
                    if (!acc[klp]) acc[klp] = [];
                    acc[klp].push(curr);
                    return acc;
                }, {});

                updateGlobalStats(data);
                renderDashboard(grouped);
                document.getElementById('last-update').innerText = "Live Update: " + new Date().toLocaleTimeString('id-ID');
            } catch (error) {
                console.error("Fetch Error:", error);
            } finally {
                refreshIcon.classList.remove('fa-spin');
            }
        }

        function checkNewValues(oldData, newData) {
            newData.forEach((newItem, index) => {
                const oldItem = oldData.find(o => o.nama === newItem.nama);
                if(!oldItem) return;

                const posKeys = ['fisik', 'teknik', 'mental', 'jurus', 'kebangsaan', 'nu', 'pn'];
                posKeys.forEach(pos => {
                    if (newItem[pos] && !oldItem[pos]) {
                        showNotification(newItem.nama, pos.toUpperCase());
                    }
                });
            });
        }

        function updateGlobalStats(data) {
            const total = data.length;
            let finished = 0;
            data.forEach(m => {
                if(m.fisik && m.teknik && m.mental && m.jurus && m.kebangsaan && m.nu && m.pn) finished++;
            });

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-done').innerText = finished;
            const percent = Math.round((finished / total * 100)) || 0;
            document.getElementById('stat-percent').innerText = percent + '%';
            document.getElementById('global-progress').style.width = percent + '%';
        }

        function renderDashboard(grouped) {
            const container = document.getElementById('kelompok-container');
            container.innerHTML = '';

            Object.keys(grouped).sort((a, b) => a - b).forEach(klp => {
                const members = grouped[klp];
                const groupProgress = calculateGroupProgress(members);
                
                let groupHtml = `
                    <div class="glass-card rounded-[2.5rem] overflow-hidden border border-slate-100 shadow-sm">
                        <div class="bg-primary/5 px-6 py-5 flex justify-between items-center border-b border-slate-100">
                            <div>
                                <h2 class="font-black text-slate-800 text-lg">KELOMPOK ${klp}</h2>
                                <p class="text-[9px] text-primary font-bold tracking-[0.2em] uppercase">Group Progress Overview</p>
                            </div>
                            <div class="text-right">
                                <span class="text-sm font-black text-primary">${groupProgress}%</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto no-scrollbar">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50/50">
                                    <tr class="text-[9px] uppercase font-bold text-slate-400">
                                        <th class="px-6 py-4 min-w-[180px]">Nama Peserta</th>
                                        <th class="px-2 py-4 text-center">Fisik</th>
                                        <th class="px-2 py-4 text-center">Teknik</th>
                                        <th class="px-2 py-4 text-center">Mental</th>
                                        <th class="px-2 py-4 text-center">Jurus</th>
                                        <th class="px-2 py-4 text-center">Kebangsaan</th>
                                        <th class="px-2 py-4 text-center">Ke NUan</th>
                                        <th class="px-2 py-4 text-center">Pagarnusa</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                `;

                members.forEach(m => {
                    groupHtml += `
                        <tr class="hover:bg-emerald-50/30 transition-colors">
                            <td class="px-6 py-4 text-xs font-bold text-slate-700">${m.nama}</td>
                            ${renderStatusCell(m.fisik)}
                            ${renderStatusCell(m.teknik)}
                            ${renderStatusCell(m.mental)}
                            ${renderStatusCell(m.jurus)}
                            ${renderStatusCell(m.kebangsaan)}
                            ${renderStatusCell(m.nu)}
                            ${renderStatusCell(m.pn)}
                        </tr>
                    `;
                });

                groupHtml += `</tbody></table></div></div>`;
                container.innerHTML += groupHtml;
            });
        }

        function renderStatusCell(val) {
            const isDone = val !== "" && val !== null && val !== undefined;
            return `
                <td class="px-2 py-4 text-center">
                    <div class="w-7 h-7 mx-auto rounded-xl flex items-center justify-center text-[10px] font-black ${isDone ? 'bg-primary text-white shadow-lg shadow-emerald-900/20 border border-primary' : 'bg-slate-50 text-slate-200 border border-slate-100'} status-badge">
                        ${isDone ? val : '<i class="fas fa-minus opacity-30"></i>'}
                    </div>
                </td>
            `;
        }

        function calculateGroupProgress(members) {
            let totalPossible = members.length * 7;
            let current = 0;
            members.forEach(m => {
                const posKeys = ['fisik', 'teknik', 'mental', 'jurus', 'kebangsaan', 'nu', 'pn'];
                posKeys.forEach(k => { if(m[k]) current++; });
            });
            return Math.round((current / totalPossible) * 100) || 0;
        }

        window.onload = fetchData;
        setInterval(fetchData, 10000); // Sinkronisasi otomatis setiap 10 detik
    </script>
</body>
</html>