<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pagar Nusa Store - Official Checkout</title>
    <link rel="icon" href="logopn.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
        tailwind.config = { 
            theme: { 
                extend: { 
                    colors: { 
                        primary: '#1B7548', 
                        primaryDark: '#145c38' 
                    },
                    // Menambahkan tinggi custom untuk header agar seragam
                    height: { '18': '4.5rem' }
                } 
            } 
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f8fafc; 
            overflow-x: hidden; 
            scroll-behavior: smooth;
            /* Menghilangkan tap highlight abu-abu di iOS */
            -webkit-tap-highlight-color: transparent;
        }
        [x-cloak] { display: none !important; }
        
        /* Optimasi Safe Area untuk iOS (Notch & Home Indicator) */
        header { 
            padding-top: env(safe-area-inset-top); 
        }
        main { 
            padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); 
        }

        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-up { animation: slideUp 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-bounce:active { transform: scale(0.95); }
        .cart-item { transition: all 0.3s ease; }
        .cart-item:hover { transform: translateX(8px); background-color: #ecfdf5; }
        
        input::-webkit-outer-spin-button, 
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Mencegah zoom otomatis pada input di iPhone */
        @media screen and (max-width: 768px) {
            input, select, textarea { font-size: 16px !important; }
        }
    </style>
</head>
<body x-data="checkoutApp()" x-init="init()" class="antialiased select-none">

<div x-show="loading" x-cloak 
     x-transition:enter="transition ease-out duration-500"
     x-transition:leave="transition ease-in duration-500"
     class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-xl">
    <div class="relative flex flex-col items-center group">
        <div class="absolute inset-0 bg-primary/20 blur-3xl rounded-full animate-pulse"></div>
        
        <div class="relative bg-white p-12 rounded-[4rem] shadow-[0_40px_100px_-20px_rgba(0,0,0,0.5)] flex flex-col items-center max-w-xs w-[85vw] border border-white/20 transform hover:scale-105 transition-transform duration-500">
            <div class="relative mb-8">
                <div class="w-24 h-24 border-[4px] border-slate-100 border-t-primary rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <img src="logopn.png" class="h-10 w-10 object-contain animate-bounce" alt="Logo">
                </div>
            </div>
            <div class="space-y-3 text-center">
                <p x-text="loadingMsg" class="text-[10px] font-black text-slate-800 uppercase italic tracking-[0.3em] animate-pulse"></p>
                <div class="flex gap-1.5 justify-center">
                    <span class="w-1.5 h-1.5 bg-primary rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                    <span class="w-1.5 h-1.5 bg-primary rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                    <span class="w-1.5 h-1.5 bg-primary rounded-full animate-bounce"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<header class="bg-primary text-white sticky top-0 z-50 shadow-2xl backdrop-blur-md bg-opacity-95 border-b border-white/10 ring-1 ring-white/5 transition-all duration-300">
    <div class="container mx-auto px-6 h-20 md:h-22 flex justify-between items-center">
        <div class="flex items-center gap-4 group cursor-pointer">
            <div class="relative">
                <div class="absolute inset-0 bg-white/20 blur-lg rounded-full opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <img src="logopn.png" class="h-11 w-11 object-contain drop-shadow-2xl relative transform group-hover:rotate-12 transition-transform duration-500" alt="Logo">
            </div>
            <div class="flex flex-col">
                <span class="font-black leading-none text-[13px] tracking-[0.18em] uppercase text-white">PAGARNUSA</span>
                <span class="font-bold text-[9px] text-emerald-200/60 tracking-[0.3em] leading-tight uppercase mt-1">UNUSIA STORE</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div x-show="loadingData" class="flex items-center gap-2 text-[8px] font-black bg-white/10 px-4 py-2 rounded-full border border-white/10 animate-pulse">
                <i class="fas fa-sync-alt animate-spin text-emerald-400"></i>
                <span class="tracking-widest uppercase">Syncing</span>
            </div>

            <div class="relative bg-black/20 p-1 rounded-full ring-1 ring-white/10 overflow-hidden">
                <div class="text-[10px] font-black text-primary bg-white px-6 py-2.5 rounded-full shadow-lg tracking-[0.15em] flex items-center gap-3 relative z-10">
                    <span class="opacity-30 italic text-[8px]">STEP</span>
                    <span class="text-xs" x-text="step + ' / 2'"></span>
                </div>
                <div class="absolute inset-0 bg-emerald-500/20 transition-all duration-1000" :style="'width: ' + (step/2 * 100) + '%'"></div>
            </div>
        </div>
    </div>
</header>

<main class="max-w-xl mx-auto p-6 pb-32 relative">
    <div x-show="showGuide" x-cloak 
         class="fixed inset-0 z-[60] bg-slate-950/90 flex items-center justify-center p-6 backdrop-blur-xl"
         x-transition:enter="transition ease-out duration-400"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100">
        
        <div class="bg-white rounded-[4rem] w-full max-w-md max-h-[85vh] overflow-hidden relative shadow-[0_50px_100px_-20px_rgba(0,0,0,0.5)] border border-slate-100 slide-up" @click.away="showGuide = false">
            <div class="absolute top-0 left-0 w-full h-2 bg-primary"></div>
            <button @click="showGuide = false" class="absolute top-6 right-6 bg-slate-100 text-slate-400 w-12 h-12 rounded-full flex items-center justify-center font-light text-3xl z-20 hover:bg-red-500 hover:text-white transition-all shadow-sm active:scale-90">
                &times;
            </button>

            <div class="p-8 pt-12 overflow-y-auto max-h-[85vh] space-y-12 custom-scrollbar">
                <div class="text-center relative">
                    <h3 class="font-black text-slate-800 text-[13px] mb-6 uppercase italic tracking-[0.25em] flex items-center justify-center gap-4">
                        <span class="h-[1px] w-8 bg-slate-200"></span> USIA DINI <span class="h-[1px] w-8 bg-slate-200"></span>
                    </h3>
                    <div class="overflow-hidden rounded-[2.5rem] border border-slate-100 shadow-2xl">
                        <table class="w-full text-[11px] border-collapse">
                            <thead class="bg-primary text-white">
                                <tr><th class="p-4 uppercase font-black tracking-widest">Size</th><th class="p-4">Lebar</th><th class="p-4">Atas</th><th class="p-4">Bawah</th><th class="p-4">Berat</th></tr>
                            </thead>
                            <tbody class="text-slate-600 font-bold">
                                <tr class="border-b border-slate-50"><td class="p-4 bg-slate-50 font-black text-primary">S</td><td class="p-4">34</td><td class="p-4">48</td><td class="p-4">56</td><td class="p-4 text-red-500">10-15kg</td></tr>
                                <tr class="border-b border-slate-50"><td class="p-4 bg-slate-50 font-black text-primary">M</td><td class="p-4">38</td><td class="p-4">53</td><td class="p-4">62</td><td class="p-4 text-red-500">15-20kg</td></tr>
                                <tr class="border-b border-slate-50"><td class="p-4 bg-slate-50 font-black text-primary">L</td><td class="p-4">40</td><td class="p-4">59</td><td class="p-4">70</td><td class="p-4 text-red-500">20-25kg</td></tr>
                                <tr><td class="p-4 bg-slate-50 font-black text-primary">XL</td><td class="p-4">44</td><td class="p-4">65</td><td class="p-4">78</td><td class="p-4 text-red-500">25-30kg</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="text-center pb-6">
                    <h3 class="font-black text-slate-800 text-[13px] mb-6 uppercase italic tracking-[0.25em] flex items-center justify-center gap-4">
                        <span class="h-[1px] w-8 bg-slate-200"></span> DEWASA <span class="h-[1px] w-8 bg-slate-200"></span>
                    </h3>
                    <div class="overflow-hidden rounded-[2.5rem] border border-slate-100 shadow-2xl">
                        <table class="w-full text-[10px] border-collapse">
                            <thead class="bg-slate-900 text-white font-black">
                                <tr><th class="p-4 uppercase tracking-widest">Size</th><th class="p-4">Atas</th><th class="p-4">Bawah</th><th class="p-4">LD</th><th class="p-4">Berat</th></tr>
                            </thead>
                            <tbody class="text-slate-600 font-bold">
                                <template x-for="sz in [['S','68','83','48','30-45kg'],['M','70','87','51','45-55kg'],['L','71','90','53','55-65kg'],['XL','73','93','56','65-75kg'],['XXL','76','95','60','75-85kg'],['XXXL','82','98','65','85-95kg']]">
                                    <tr class="border-b border-slate-50 hover:bg-emerald-50/50 transition-colors">
                                        <td class="p-4 bg-slate-50 font-black text-slate-900" x-text="sz[0]"></td>
                                        <td class="p-4" x-text="sz[1]"></td>
                                        <td class="p-4" x-text="sz[2]"></td>
                                        <td class="p-4" x-text="sz[3]"></td>
                                        <td class="p-4 text-red-500" x-text="sz[4]"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="!isSuccess" 
         class="bg-white rounded-[4rem] shadow-[0_40px_100px_-20px_rgba(0,0,0,0.12)] p-10 border border-slate-100 relative overflow-hidden fade-in mx-1">
        
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary via-emerald-300 to-primary"></div>
        
        <div x-show="step === 1" x-transition:enter="transition ease-out duration-700 transform" x-transition:enter-start="translate-x-12 opacity-0" class="space-y-10">
            <div class="space-y-3">
                <h2 class="text-[28px] font-black text-slate-900 tracking-tight leading-tight">Identitas Pemesan</h2>
                <div class="flex items-center gap-3">
                    <span class="h-1 w-10 bg-primary rounded-full"></span>
                    <p class="text-[10px] text-slate-400 font-black tracking-[0.18em]">isi identitas yang benar</p>
                </div>
            </div>

            <div class="space-y-6">
                <template x-for="field in [{m:'nama', l:'Nama Lengkap', p:'Nama Sesuai KTP', i:'fa-user', t:'text'}, {m:'email', l:'Email Pemesan', p:'contoh@gmail.com', i:'fa-envelope', t:'email'}, {m:'wa', l:'Nomor Whatsapp', p:'08xxxxxx', i:'fa-whatsapp', t:'tel'}]">
                    <div class="group relative">
                        <label class="text-[10px] font-black text-primary/50 absolute -top-2.5 left-8 bg-white px-3 z-10 transition-all group-focus-within:text-primary group-focus-within:scale-105" x-text="field.l"></label>
                        <div class="relative">
                            <i :class="'fas ' + field.i" class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-primary transition-colors"></i>
                            <input :type="field.t" x-model="form[field.m]" :placeholder="field.p" class="w-full pl-14 pr-8 py-5.5 rounded-[1.8rem] border-2 border-slate-100 focus:border-primary focus:ring-[10px] focus:ring-primary/5 outline-none text-[14px] font-bold transition-all placeholder:text-slate-200 placeholder:font-medium">
                        </div>
                    </div>
                </template>

                <div class="group relative">
                    <label class="text-[10px] font-black text-primary/50 absolute -top-2.5 left-8 bg-white px-3 z-10">Pesan Sebagai</label>
                    <div class="relative">
                        <i class="fas fa-id-badge absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-primary transition-colors"></i>
                        <select x-model="form.sebagai" class="w-full pl-14 pr-12 py-5.5 rounded-[1.8rem] border-2 border-slate-100 bg-white text-[14px] font-bold outline-none focus:border-primary focus:ring-[10px] focus:ring-primary/5 appearance-none cursor-pointer transition-all">
                            <option value="Wali Santri">Wali Santri</option>
                            <option value="Pelatih">Pelatih / Pengurus</option>
                            <option value="Pribadi">Pribadi / Santri</option>
                        </select>
                        <div class="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-300">
                            <i class="fas fa-chevron-down text-[10px]"></i>
                        </div>
                    </div>
                </div>

                <button @click="step = 2" :disabled="!form.nama || !form.wa || !form.email" class="w-full bg-primary text-white font-black py-7 rounded-[2rem] shadow-[0_25px_50px_-10px_rgba(27,117,72,0.4)] hover:bg-primaryDark transition-all disabled:opacity-20 flex items-center justify-center gap-4 btn-bounce group overflow-hidden relative">
                    <div class="absolute inset-0 bg-white/10 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000"></div>
                    <span class="tracking-[0.1em] text-[13px]">Lanjut Pesan</span>
                    <i class="fas fa-chevron-right text-[10px] group-hover:translate-x-2 transition-transform"></i>
                </button>
            </div>
        </div>

        <div x-show="step === 2" x-cloak x-transition:enter="transition ease-out duration-700 transform" x-transition:enter-start="translate-x-12 opacity-0" class="space-y-10">
            <div class="flex justify-between items-center">
                <div class="space-y-2">
                    <h2 class="text-2xl font-black text-slate-900 tracking-tighter">Detail Pesanan</h2>
                    <p class="text-[9px] text-slate-400 font-black tracking-[0.0em]">Pilih Sesuai keinginan Seragam</p>
                </div>
                <button @click="showGuide = true" class="px-5 py-3 bg-slate-50 rounded-2xl text-[10px] font-black text-primary border border-slate-100 flex items-center gap-2 hover:bg-primary hover:text-white transition-all active:scale-90">
                    <i class="fas fa-ruler-combined"></i> Panduan Size
                </button>
            </div>
            
            <div class="bg-slate-50/50 p-8 rounded-[3.5rem] border-2 border-dashed border-slate-200/60 relative space-y-8">
                <div class="relative group">
                    <label class="text-[9px] font-black text-slate-400 absolute -top-2.5 left-6 bg-[#fcfdfe] px-3 uppercase tracking-widest z-10">Jenjang Lembaga</label>
                    <select x-model="temp.lembaga" @change="temp.ukuran = ''; temp.qty = 1" class="w-full p-6 rounded-[1.8rem] border border-slate-200 text-xs font-black outline-none focus:border-primary bg-white appearance-none shadow-xl shadow-black/[0.02] transition-all">
                        <option value="">-- Pilih Lembaga --</option>
                        <template x-for="l in daftarLembaga"><option :value="l" x-text="l"></option></template>
                    </select>
                    <div class="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-200">
                        <i class="fas fa-university"></i>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-3" x-show="temp.lembaga" x-transition:enter="transition duration-500 ease-out transform scale-95">
                    <template x-for="s in listUkuranTersedia">
                        <button @click="selectSize(s)" 
                            :disabled="getRemainingStock(s) <= 0"
                            :class="[
                                temp.ukuran === s.ukuran ? 'bg-primary text-white border-primary shadow-[0_15px_30px_-5px_rgba(27,117,72,0.3)] ring-[6px] ring-primary/10' : 'bg-white text-slate-500 border-slate-100',
                                getRemainingStock(s) <= 0 ? 'opacity-30 grayscale cursor-not-allowed' : 'hover:border-primary/30 transition-all active:scale-95'
                            ]"
                            class="p-5 rounded-[1.8rem] border-2 text-[12px] font-black flex flex-col items-center gap-1.5 transition-all">
                            <span class="text-xs tracking-tighter" x-text="s.ukuran"></span>
                            <span class="text-[7px] font-black uppercase opacity-60" x-text="getRemainingStock(s) > 0 ? 'Sisa: ' + getRemainingStock(s) : 'Habis'"></span>
                        </button>
                    </template>
                </div>

                <div x-show="temp.ukuran" x-transition class="flex items-center justify-between bg-white p-5 rounded-[1.8rem] border border-slate-100 shadow-sm">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Jumlah:</span>
                    <div class="flex items-center gap-5">
                        <button @click="if(temp.qty > 1) temp.qty--" class="w-11 h-11 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-800 hover:bg-slate-200 active:scale-90 transition-all font-black border border-slate-100 shadow-sm">-</button>
                        <input type="number" x-model.number="temp.qty" @input="validateQty" class="w-10 text-center font-black text-primary text-lg bg-transparent outline-none">
                        <button @click="if(temp.qty < temp.availableLimit) temp.qty++" class="w-11 h-11 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-800 hover:bg-slate-200 active:scale-90 transition-all font-black border border-slate-100 shadow-sm">+</button>
                    </div>
                </div>

                <button @click="addItem" :disabled="!temp.ukuran || temp.availableLimit <= 0" class="w-full bg-slate-900 text-white text-[11px] font-black py-6 rounded-[1.8rem] shadow-2xl hover:bg-black transition-all flex items-center justify-center gap-3 disabled:opacity-20 active:scale-95 group">
                    <i class="fas fa-plus-circle group-hover:rotate-90 transition-transform"></i>
                    <span class="tracking-widest">TAMBAHKAN KE DAFTAR</span>
                </button>
            </div>

            <div class="space-y-4">
                <template x-for="(item, index) in cart" :key="index">
                    <div class="flex justify-between items-center bg-white p-6 rounded-[2.5rem] border border-slate-50 shadow-[0_15px_40px_-15px_rgba(0,0,0,0.05)] cart-item border-l-4 border-l-primary">
                        <div class="flex items-center gap-5">
                            <div class="w-12 h-12 bg-primary/5 text-primary rounded-[1.2rem] flex items-center justify-center text-[12px] font-black border border-primary/10" x-text="item.ukuran"></div>
                            <div class="flex flex-col">
                                <p class="text-[12px] font-black text-slate-800 tracking-tight" x-text="item.lembaga"></p>
                                <p class="text-[10px] font-bold text-emerald-600 mt-0.5" x-text="item.qty + ' Pcs • ' + formatRupiah(item.hargaTotal)"></p>
                            </div>
                        </div>
                        <button @click="cart.splice(index, 1)" class="w-12 h-12 rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all duration-300 flex items-center justify-center shadow-inner active:scale-90">
                            <i class="fas fa-trash-alt text-[11px]"></i>
                        </button>
                    </div>
                </template>
            </div>

            <div x-show="cart.length > 0" class="bg-slate-900 text-white p-10 rounded-[4rem] shadow-[0_40px_80px_-20px_rgba(0,0,0,0.4)] space-y-10 border border-white/10 relative overflow-hidden fade-in">
                <div class="absolute top-0 right-0 w-48 h-48 bg-primary/20 rounded-full -mr-24 -mt-24 blur-[80px]"></div>
                <div class="absolute bottom-0 left-0 w-32 h-32 bg-emerald-500/10 rounded-full -ml-16 -mb-16 blur-[60px]"></div>

                <div class="flex justify-between items-start relative z-10">
                    <div class="space-y-2">
                        <span class="text-[10px] font-black text-white/30 uppercase tracking-[0.3em]">Total Invoice</span>
                        <div class="text-4xl font-black text-emerald-400 tracking-tighter" x-text="formatRupiah(grandTotal)"></div>
                    </div>
                    <img src="https://images.seeklogo.com/logo-png/62/2/seabank-logo-png_seeklogo-620133.png" class="h-9 object-contain brightness-0 invert opacity-40" alt="Seabank">
                </div>

                <div class="bg-white/5 border border-white/10 rounded-[2.5rem] p-7 space-y-5 relative z-10 backdrop-blur-sm">
                    <div class="flex justify-between items-center px-3">
                        <span class="text-[9px] font-black text-white/20 uppercase tracking-[0.2em]">Metode Transfer</span>
                        <span class="text-[11px] font-black text-emerald-400 italic">E-wallet Seabank(901)</span>
                    </div>
                    <div class="flex justify-between items-center bg-black/40 p-5 rounded-[1.8rem] border border-white/5 ring-4 ring-white/[0.02]">
                        <div class="flex flex-col">
                            <span class="text-[8px] font-black text-white/20 tracking-widest mb-1.5">No. Rekening</span>
                            <span class="text-[17px] font-mono font-black text-white tracking-[0.15em]">901898555541</span>
                        </div>
                        <button @click="copyToClipboard('901898555541')" class="bg-white text-slate-900 px-6 py-3 rounded-2xl text-[10px] font-black active:scale-95 hover:bg-emerald-400 hover:text-white transition-all shadow-2xl">SALIN</button>
                    </div>
                    <p class="text-center text-[9px] font-black text-white/40 tracking-[0.2em] uppercase">A.N MUHAMMAD IBNU MUNDZIR</p>
                </div>
                
                <div class="pt-4 relative z-10">
                    <label class="block text-[10px] font-black text-white/20 mb-5 text-center tracking-[0.0em]">Lampirkan Bukti Pembayaran</label>
                    <div class="relative group">
                        <input type="file" @change="uploadFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                        <div class="bg-white/5 border-2 border-dashed border-white/10 rounded-[2.5rem] p-10 text-center group-hover:border-emerald-500/50 group-hover:bg-white/[0.07] transition-all duration-700">
                            <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 shadow-2xl ring-8 ring-white/[0.02]">
                                <i class="fas fa-cloud-upload-alt text-2xl text-white/20 group-hover:text-emerald-400 transition-colors"></i>
                            </div>
                            <p class="text-[12px] font-black tracking-tight" :class="form.buktiBase64 ? 'text-emerald-400' : 'text-white/30'" x-text="form.buktiBase64 ? '✓ BERKAS BERHASIL DIUNGGAH' : 'TEKAN UNTUK PILIH GAMBAR'"></p>
                            <p class="text-[8px] font-bold text-white/10 mt-2">Maksimal 5MB (JPG/PNG)</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex gap-4 pt-4">
                <button @click="step = 1" class="flex-1 bg-slate-50 text-slate-400 font-black py-7 rounded-[2rem] text-[11px] transition-all hover:bg-slate-100 active:scale-95 border border-slate-100 tracking-widest">KEMBALI</button>
                <button @click="submit" :disabled="loading || cart.length === 0 || !form.buktiBase64" class="flex-[2.5] bg-primary text-white font-black py-7 rounded-[2rem] shadow-[0_30px_60px_-15px_rgba(27,117,72,0.4)] hover:bg-primaryDark transition-all disabled:opacity-20 flex items-center justify-center gap-4 active:scale-95 relative overflow-hidden">
                    <span x-show="!loading" class="tracking-[0.0em] text-[12px]">Bayar</span>
                    <i x-show="loading" class="fas fa-spinner animate-spin"></i>
                </button>
            </div>
        </div>
    </div>

    <div x-show="isSuccess" x-cloak class="max-w-md mx-auto space-y-10 fade-in pb-12">
        
        <div class="text-center bg-white p-12 rounded-[4rem] shadow-2xl border-b-[12px] border-primary relative overflow-hidden ring-1 ring-slate-100">
            <div class="absolute -top-16 -right-16 w-56 h-56 bg-emerald-50 rounded-full opacity-40 animate-pulse"></div>
            
            <div class="w-28 h-28 bg-primary text-white rounded-[2.5rem] flex items-center justify-center mx-auto mb-8 shadow-[0_20px_50px_-10px_rgba(27,117,72,0.5)] animate-bounce relative z-10 rotate-12">
                <i class="fas fa-check text-5xl"></i>
            </div>
            
            <h2 class="text-3xl font-black uppercase text-slate-900 tracking-tighter italic leading-none">Berhasil!</h2>
            <p class="text-slate-400 text-[11px] mt-4 font-black uppercase tracking-[0.3em] leading-relaxed">Pesanan telah masuk ke sistem kami</p>
        </div>

        <div id="invoice-preview" class="bg-white p-10 rounded-[4rem] shadow-[0_30px_80px_-20px_rgba(0,0,0,0.1)] border border-slate-50 relative overflow-hidden group">
            <div class="absolute -left-4 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#f8fafc] rounded-full ring-1 ring-slate-100 shadow-inner"></div>
            <div class="absolute -right-4 top-1/2 -translate-y-1/2 w-8 h-8 bg-[#f8fafc] rounded-full ring-1 ring-slate-100 shadow-inner"></div>

            <div class="flex justify-between items-start border-b-2 border-dashed border-slate-100 pb-8 mb-8">
                <div class="space-y-2">
                    <h3 class="font-black text-primary text-[12px] uppercase tracking-[0.3em] italic">DIGITAL RECEIPT</h3>
                    <p class="text-[10px] text-slate-300 font-mono font-bold uppercase tracking-widest" x-text="new Date().toLocaleString('id-ID')"></p>
                </div>
                <div class="text-right">
                    <span class="text-[9px] font-black text-slate-300 block uppercase tracking-widest mb-1.5">No. Referensi:</span>
                    <span class="text-xs font-black text-slate-900 font-mono bg-slate-50 px-4 py-2 rounded-xl" x-text="finalOrderID"></span>
                </div>
            </div>

            <div class="space-y-5 mb-10 px-2">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400 font-black uppercase text-[10px] tracking-widest">Atas Nama:</span>
                    <span class="font-black text-slate-900 uppercase italic text-[13px]" x-text="form.nama"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Status:</span>
                    <div class="flex items-center gap-2.5 bg-emerald-50 px-4 py-1.5 rounded-full border border-emerald-100">
                         <span class="h-2 w-2 bg-emerald-500 rounded-full animate-pulse"></span>
                         <span class="text-emerald-600 font-black text-[10px] uppercase italic tracking-widest">Paid Verified</span>
                    </div>
                </div>
            </div>

            <div class="bg-slate-50/70 rounded-[3rem] p-8 space-y-6 mb-8 border border-slate-100 shadow-inner">
                <template x-for="item in cart" :key="item.id">
                    <div class="flex justify-between items-center group/item transform hover:translate-x-1 transition-transform">
                        <div class="flex flex-col">
                            <span class="font-black text-slate-800 text-[12px] uppercase tracking-tight" x-text="item.lembaga + ' | ' + item.ukuran"></span>
                            <span class="text-[10px] text-slate-400 font-bold mt-0.5" x-text="item.qty + ' Pcs @ ' + formatRupiah(item.harga)"></span>
                        </div>
                        <span class="font-black text-slate-900 text-[13px] font-mono tracking-tighter" x-text="formatRupiah(item.harga * item.qty)"></span>
                    </div>
                </template>
                
                <div class="border-t-2 border-slate-200/50 mt-6 pt-6 flex justify-between items-center">
                    <span class="font-black text-slate-400 text-[11px] uppercase tracking-[0.3em]">Total Bayar</span>
                    <span class="font-black text-primary text-2xl font-mono tracking-tighter" x-text="formatRupiah(grandTotal)"></span>
                </div>
            </div>

            <div class="text-center py-4 relative">
                <div class="absolute inset-0 flex items-center justify-center opacity-[0.05] select-none pointer-events-none -rotate-12">
                     <span class="text-[70px] font-black italic">LUNAS</span>
                </div>
                <div class="inline-block px-8 py-3 border border-slate-100 rounded-2xl bg-white shadow-sm relative z-10">
                    <p class="text-[10px] font-black tracking-[0.4em] text-slate-300 uppercase">PN UNUSIA STORE OFFICIAL</p>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-5 pt-4 px-4">
            <button @click="downloadKwitansi()" class="bg-slate-900 text-white font-black py-7 rounded-[2.5rem] shadow-[0_30px_60px_-15px_rgba(0,0,0,0.3)] flex items-center justify-center gap-5 active:scale-95 hover:bg-black transition-all text-[12px] group overflow-hidden relative">
                <div class="absolute inset-0 bg-white/5 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                <div class="w-10 h-10 bg-white/10 rounded-2xl flex items-center justify-center group-hover:rotate-12 transition-transform">
                    <i class="fas fa-file-pdf text-emerald-400 text-lg"></i> 
                </div>
                <span class="tracking-[0.2em] relative z-10">UNDUH KWITANSI DIGITAL</span>
            </button>
            
            <a :href="waUrl" target="_blank" class="bg-emerald-500 text-white font-black py-7 rounded-[2.5rem] shadow-[0_20px_40px_-10px_rgba(16,185,129,0.4)] flex items-center justify-center gap-5 active:scale-95 hover:opacity-95 transition-all text-[12px] group">
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fab fa-whatsapp text-xl"></i>
                </div>
                <span class="tracking-[0.2em] uppercase">Konfirmasi Admin</span>
            </a>

            <button @click="location.reload()" class="text-slate-300 font-black py-6 text-[11px] hover:text-primary transition-all uppercase tracking-[0.5em] text-center active:scale-90 flex items-center justify-center gap-3">
                <i class="fas fa-home text-[10px]"></i> KEMBALI KE BERANDA
            </button>
        </div>
    </div>
</main>

<div x-show="copied" x-cloak 
     x-transition:enter="transition ease-out duration-300 transform"
     x-transition:enter-start="opacity-0 translate-y-20"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-300 transform"
     x-transition:leave-end="opacity-0 translate-y-20"
     class="fixed bottom-16 left-1/2 -translate-x-1/2 bg-slate-900 text-emerald-400 px-10 py-5 rounded-[2rem] text-[11px] font-black shadow-[0_30px_60px_rgba(0,0,0,0.5)] z-[100] border border-white/10 tracking-[0.2em] uppercase flex items-center gap-4">
    <div class="w-6 h-6 bg-emerald-400 text-slate-900 rounded-full flex items-center justify-center text-[10px]">
        <i class="fas fa-check"></i>
    </div>
    DATA BERHASIL DISALIN
</div>

<script>
    function checkoutApp() {
        return {
            step: 1, 
            loading: false, 
            loadingMsg: '',
            loadingData: false, 
            isSuccess: false, 
            showGuide: false, 
            copied: false,
            finalOrderID: '',
            form: { nama: '', email: '', wa: '', sebagai: 'Pribadi', buktiBase64: '' },
            temp: { lembaga: '', ukuran: '', harga: 0, qty: 1, availableLimit: 0 },
            cart: [],
            dbStok: [
                {lembaga: "TK/SD", ukuran: "S", stok: 0, harga: 175000},
                {lembaga: "TK/SD", ukuran: "M", stok: 0, harga: 175000},
                {lembaga: "TK/SD", ukuran: "L", stok: 0, harga: 175000},
                {lembaga: "TK/SD", ukuran: "XL", stok: 0, harga: 175000},
                {lembaga: "SMP/SMA/Dewasa", ukuran: "S", stok: 0, harga: 180000},
                {lembaga: "SMP/SMA/Dewasa", ukuran: "M", stok: 0, harga: 185000},
                {lembaga: "SMP/SMA/Dewasa", ukuran: "L", stok: 0, harga: 190000},
                {lembaga: "SMP/SMA/Dewasa", ukuran: "XL", stok: 0, harga: 195000},
                {lembaga: "SMP/SMA/Dewasa", ukuran: "XXL", stok: 0, harga: 200000},
                {lembaga: "SMP/SMA/Dewasa", ukuran: "XXXL", stok: 0, harga: 205000}
            ],
            scriptUrl: 'https://script.google.com/macros/s/AKfycbxw19azk92bUVGoGJBBgYYaM69W0qu0ukA3ED6yth0yTgGxJmDqVqSNyTfMhXiQNgL8/exec',
            waUrl: '6285715232441',

            async init() {
                this.loadingData = true;
                try {
                    const res = await fetch(this.scriptUrl + '?t=' + Date.now());
                    const data = await res.json();
                    if(data && Array.isArray(data) && data.length > 0) {
                        this.dbStok = data;
                    }
                } catch (e) { 
                    console.warn("Mode Offline aktif - Menggunakan data cadangan"); 
                } finally {
                    this.loadingData = false;
                }
            },

            get daftarLembaga() { 
                return [...new Set(this.dbStok.map(i => i.lembaga))]; 
            },

            get listUkuranTersedia() {
                return this.dbStok.filter(i => i.lembaga === this.temp.lembaga);
            },

            getRemainingStock(item) {
                const inCart = this.cart
                    .filter(c => c.lembaga === item.lembaga && c.ukuran === item.ukuran)
                    .reduce((sum, c) => sum + c.qty, 0);
                return Math.max(0, item.stok - inCart);
            },

            selectSize(s) {
                const limit = this.getRemainingStock(s);
                if(limit <= 0) return;
                this.temp.ukuran = s.ukuran;
                this.temp.harga = s.harga;
                this.temp.availableLimit = limit;
                this.temp.qty = 1;
            },

            validateQty() {
                if(this.temp.qty > this.temp.availableLimit) this.temp.qty = this.temp.availableLimit;
                if(this.temp.qty < 1 || !this.temp.qty) this.temp.qty = 1;
            },

            addItem() {
                if(!this.temp.ukuran) return;
                this.cart.push({
                    lembaga: this.temp.lembaga,
                    ukuran: this.temp.ukuran,
                    qty: this.temp.qty,
                    harga: this.temp.harga,
                    hargaTotal: this.temp.harga * this.temp.qty
                });
                this.temp.ukuran = '';
                this.temp.qty = 1;
            },

            get grandTotal() { return this.cart.reduce((a, b) => a + b.hargaTotal, 0); },

            formatRupiah(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); },

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.copied = true;
                    setTimeout(() => this.copied = false, 2000);
                });
            },

            uploadFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                if(file.size > 2 * 1024 * 1024) {
                    alert("Ukuran foto terlalu besar. Maksimal 2MB.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = (f) => this.form.buktiBase64 = f.target.result.split(',')[1];
                reader.readAsDataURL(file);
            },

            // Fungsi Helper untuk membuat konten PDF agar konsisten
            generatePDFDoc() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = { left: 25, right: 25, top: 15, bottom: 15 };
                const centerX = pageWidth / 2;

                const logoUrl = "https://lh3.googleusercontent.com/d/1drM76LlU3sdqpwo-Urq7ZULoyORC0UMQ"; 
                try { doc.addImage(logoUrl, 'PNG', margin.left, margin.top, 20, 20); } catch (e) {}

                doc.setFont("helvetica", "bold").setFontSize(14).setTextColor(0, 0, 0);
                doc.text("PIMPINAN RAYON", 50, margin.top + 7);
                doc.setFontSize(18).setTextColor(27, 117, 72).text("PSNU PAGARNUSA UNUSIA", 50, margin.top + 15);
                doc.setFontSize(9).setTextColor(100).setFont("helvetica", "normal");
                doc.text("Sekretariat: Kampus UNUSIA, Bogor. | Email: ukmpagarnusaunusia@gmail.com", 50, margin.top + 20);

                doc.setLineWidth(0.8).setDrawColor(0, 0, 0).line(margin.left, margin.top + 25, pageWidth - margin.right, margin.top + 25);
                doc.setLineWidth(0.2).line(margin.left, margin.top + 26.5, pageWidth - margin.right, margin.top + 26.5);

                doc.setFontSize(12).setTextColor(0, 0, 0).setFont("helvetica", "bold").text("SURAT BUKTI PEMESANAN (INVOICE)", centerX, margin.top + 38, { align: "center" });
                doc.setFontSize(9).setFont("helvetica", "normal").text(`No. Referensi: ${this.finalOrderID}`, centerX, margin.top + 43, { align: "center" });

                doc.setFontSize(10).text("DATA PEMESAN:", margin.left, margin.top + 55);
                doc.setFont("helvetica", "bold").text(`Nama : ${this.form.nama.toUpperCase()}`, margin.left, margin.top + 60);
                doc.setFont("helvetica", "normal").text(`Email : ${this.form.email}`, margin.left, margin.top + 65);
                doc.text(`WhatsApp : ${this.form.wa}`, margin.left, margin.top + 70);
                
                const tglCetak = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'});
                doc.setFontSize(8).text(`Waktu Transaksi: ${tglCetak}`, pageWidth - margin.right, margin.top + 60, { align: "right" });

                const rows = this.cart.map((item, index) => [
                    index + 1,
                    `Seragam Silat ${item.lembaga}\nSize: ${item.ukuran}`, // TAMBAHKAN "Seragam Silat" DI SINI
                    item.qty,
                    `Rp ${item.harga.toLocaleString('id-ID')}`,
                    `Rp ${item.hargaTotal.toLocaleString('id-ID')}`
                ]);

                doc.autoTable({
                    head: [['NO', 'DESKRIPSI PRODUK', 'QTY', 'HARGA SATUAN', 'SUBTOTAL']],
                    body: rows,
                    startY: margin.top + 78,
                    margin: { left: margin.left, right: margin.right },
                    headStyles: { 
                        fillColor: [27, 117, 72], 
                        halign: 'center', 
                        valign: 'middle',
                        fontStyle: 'bold',
                        fontSize: 10
                    },
                    columnStyles: { 
                        0: { halign: 'center', cellWidth: 10 }, 
                        1: { halign: 'left', cellWidth: 'auto' }, // Deskripsi Produk
                        2: { halign: 'center', cellWidth: 15 }, 
                        3: { halign: 'right', cellWidth: 35 }, 
                        4: { halign: 'right', cellWidth: 35 } 
                    },
                    foot: [[
                        { content: '', colSpan: 2 }, 
                        { content: '', colSpan: 1 }, 
                        { content: 'TOTAL PEMBAYARAN', styles: { halign: 'right', fontStyle: 'bold' } }, 
                        { content: `Rp ${this.grandTotal.toLocaleString('id-ID')}`, styles: { halign: 'right', fontStyle: 'bold', textColor: [27, 117, 72] } }
                    ]],
                    footStyles: { fillColor: [245, 245, 245], textColor: [0, 0, 0] },
                    theme: 'grid',
                    styles: { 
                        fontSize: 9, 
                        cellPadding: 4, 
                        valign: 'middle', 
                        overflow: 'linebreak', // Memastikan teks \n berfungsi sebagai baris baru
                        rowHeight: 15 
                    },
                    didParseCell: function(data) {
                        // Memberikan padding ekstra khusus untuk kolom deskripsi agar teks tidak menempel ke garis
                        if (data.column.index === 1 && data.section === 'body') {
                            data.cell.styles.cellPadding = { top: 4, bottom: 4, left: 3, right: 3 };
                        }
                    }
                });

                let ySign = doc.lastAutoTable.finalY + 15;
                if (ySign + 40 > pageHeight) { doc.addPage(); ySign = 20; }
                doc.setFontSize(10).text("Bogor, " + new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}), pageWidth - margin.right - 10, ySign, { align: "center" });
                const signPos = pageWidth - margin.right - 35;
                doc.text("Bendahara,", signPos + 25, ySign + 7, { align: "center" });
                const urlTtd = "";
                if (urlTtd) {
                    try {
                        // Parameter: (gambar, tipe, x, y, lebar, tinggi)
                        doc.addImage(urlTtd, 'https://lh3.googleusercontent.com/d/1Al66aC10I3bZ5qzJMyNzV1OlvNBb08N2', signPos + 10, ySign + 8, 30, 22);
                    } catch (e) {
                        console.warn("Gagal memuat gambar TTD:", e);
                    }
                }
                // ----------------------------------------------------------

                doc.setFont("helvetica", "bold underline").text("SYIFA ULYA SETIAWAN", signPos + 25, ySign + 33, { align: "center" });
                doc.setFont("helvetica", "normal").setFontSize(8).text("NIA: 27091985", signPos + 25, ySign + 37, { align: "center" });
                
                doc.setDrawColor(200).line(margin.left, pageHeight - 15, pageWidth - margin.right, pageHeight - 15);
                doc.setFontSize(7).setTextColor(150).text("Simpan bukti ini sebagai syarat pengambilan atribut. Dicetak secara sistem oleh Brankas Psnu Pagarnusa Unusia Store.", centerX, pageHeight - 10, { align: "center" });
                
                return doc;
            },

            async submit() {
                if(this.loading) return;
                this.loading = true;
                
                try {
                    // Tahap 1: Inisialisasi
                    this.loadingMsg = "Menyiapkan sistem...";
                    this.finalOrderID = `KWS1985${Math.floor(100 + Math.random() * 899)}`;
                    await new Promise(r => setTimeout(r, 100)); // Beri nafas untuk browser render UI

                    // Tahap 2: Generate PDF (Proses Berat)
                    this.loadingMsg = "Membangun berkas PDF...";
                    const doc = this.generatePDFDoc();
                    const pdfBase64 = doc.output('datauristring').split(',')[1];

                    // Tahap 3: Menyiapkan Payload
                    this.loadingMsg = "Mengunggah bukti bayar...";
                    const payload = { 
                        ...this.form, 
                        orderID: this.finalOrderID,
                        items: this.cart, 
                        grandTotal: this.grandTotal,
                        pdfBase64: pdfBase64,
                        tanggal: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
                    };

                    // Tahap 4: Pengiriman (Latency GAS paling tinggi di sini)
                    this.loadingMsg = "Pesanan Diproses...";
                    
                    // Menggunakan Promise.all agar loading minimal berjalan 2 detik 
                    // sehingga tidak "kaget" jika tiba-tiba sukses atau gagal
                    const res = await fetch(this.scriptUrl, { 
                        method: 'POST', 
                        body: JSON.stringify(payload)
                    });
                    
                    const text = await res.text();
                    
                    if (text.includes("Success")) {
                        this.loadingMsg = "Hampir selesai...";
                        const details = this.cart.map(i => `- ${i.lembaga} (${i.ukuran}) x${i.qty}`).join('%0A');
                        this.waUrl = `https://wa.me/6285715232441?text=Halo Kang/Mbak, Saya *${this.form.nama}*%0A(ID: ${this.finalOrderID})%0A%0APesanan:%0A${details}%0A%0ATotal: ${this.formatRupiah(this.grandTotal)}`;
                        
                        this.isSuccess = true;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        throw new Error("Respon server tidak valid");
                    }
                } catch (e) { 
                    console.error(e);
                    alert('Maaf, server sedang sibuk. Coba sesaat lagi atau hubungi admin.'); 
                } finally { 
                    this.loading = false; 
                    this.loadingMsg = '';
                }
            },

            async downloadKwitansi() {
                const doc = this.generatePDFDoc();
                doc.save(`PN_${this.finalOrderID}_${this.form.nama.replace(/\s+/g, '_')}.pdf`);
            }
        }
    }
</script>
</body>
</html>

