<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Scanner - Pagarnusa Unusia</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Memperbaiki tampilan area scan agar kotak */
        #reader { border: none !important; }
        #reader video { border-radius: 0px !important; object-fit: cover !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-md mx-auto p-4">
        <div class="bg-[#1b7548] text-white p-6 rounded-t-2xl text-center shadow-lg">
            <h1 class="text-xl font-bold uppercase tracking-widest">Validasi Pesanan</h1>
            <p class="text-xs opacity-80">Scan QR Code pada Kwitansi Pelanggan</p>
        </div>

        <div class="bg-black relative overflow-hidden shadow-inner aspect-square">
            <div id="reader" class="w-full h-full"></div>
            <div id="scanOverlay" class="absolute inset-0 border-[40px] border-black/40 pointer-events-none z-10">
                <div class="w-full h-full border-2 border-dashed border-white/60 rounded-lg shadow-[0_0_15px_rgba(255,255,255,0.3)]"></div>
            </div>
        </div>

        <div id="statusBox" class="bg-white p-6 rounded-b-2xl shadow-lg border-t border-gray-100">
            <div id="idleState">
                <p class="text-center text-gray-500 italic text-sm">Mengarahkan kamera ke QR Code...</p>
                <div class="mt-4 flex justify-center">
                    <button onclick="startScanning()" class="bg-[#1b7548] text-white px-4 py-2 rounded-lg text-xs font-bold">AKTIFKAN KAMERA</button>
                </div>
            </div>

            <div id="resultState" class="hidden animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">DATA DITEMUKAN</span>
                    <span id="resOrderID" class="font-mono font-bold text-gray-800"></span>
                </div>
                
                <div class="space-y-3 text-left">
                    <div>
                        <label class="text-[10px] text-gray-400 block uppercase italic">Nama Pemesan</label>
                        <p id="resNama" class="font-semibold text-gray-800 text-lg"></p>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 block uppercase italic">Rincian Item</label>
                        <ul id="resItems" class="text-sm text-gray-600 list-disc list-inside"></ul>
                    </div>
                    <div class="pt-3 border-t">
                        <label class="text-[10px] text-gray-400 block uppercase italic">Total Bayar</label>
                        <p id="resTotal" class="font-bold text-[#1b7548] text-xl"></p>
                    </div>
                </div>

                <button onclick="resetScanner()" class="w-full mt-6 bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">
                    SCAN PESANAN LAIN
                </button>
            </div>

            <div id="loadingState" class="hidden text-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#1b7548] mx-auto"></div>
                <p class="text-sm text-gray-500 mt-2">Mencari di database...</p>
            </div>
        </div>
    </div>

<script>
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbxw19azk92bUVGoGJBBgYYaM69W0qu0ukA3ED6yth0yTgGxJmDqVqSNyTfMhXiQNgL8/exec';
    let html5QrCode;

    // Fungsi Memulai Scanner (Penting untuk izin browser HP)
    function startScanning() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        // Memilih kamera belakang (environment) secara otomatis
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            // Jika berhasil scan
            html5QrCode.pause(true); // Jeda kamera
            cariDataPesanan(decodedText.trim());
        }).catch(err => {
            alert("Gagal akses kamera. Pastikan izin kamera diizinkan dan gunakan HTTPS.");
        });
        
        document.querySelector('button[onclick="startScanning()"]').classList.add('hidden');
    }

    async function cariDataPesanan(orderID) {
        showState('loading');
        try {
            const response = await fetch(scriptUrl + '?type=pesanan&t=' + Date.now());
            const database = await response.json();
            
            // Cari data di kolom index 0 (Order ID)
            const row = database.find(r => r[0].toString() === orderID.toString());

            if (row) {
                tampilkanHasil({
                    orderID: row[0],
                    nama: row[1],
                    itemRincian: row[5],
                    total: row[7]
                }, orderID);
            } else {
                alert("ID " + orderID + " Tidak Terdaftar!");
                resetScanner();
            }
        } catch (error) {
            alert("Error database: Pastikan Web App sudah Deploy sebagai 'Anyone'");
            resetScanner();
        }
    }

    function tampilkanHasil(data, orderID) {
        document.getElementById('resOrderID').innerText = "#" + orderID;
        document.getElementById('resNama').innerText = data.nama;
        document.getElementById('resTotal').innerText = "Rp " + (parseInt(data.total) || 0).toLocaleString('id-ID');
        document.getElementById('resItems').innerHTML = `<li>${data.itemRincian}</li>`;
        showState('result');
        document.getElementById('scanOverlay').classList.add('hidden');
    }

    function showState(state) {
        document.getElementById('idleState').classList.toggle('hidden', state !== 'idle');
        document.getElementById('loadingState').classList.toggle('hidden', state !== 'loading');
        document.getElementById('resultState').classList.toggle('hidden', state !== 'result');
    }

    function resetScanner() {
        showState('idle');
        document.getElementById('scanOverlay').classList.remove('hidden');
        if (html5QrCode) html5QrCode.resume();
    }

    // Jalankan otomatis saat buka (jika browser mendukung auto-start)
    window.onload = startScanning;
</script>
</body>
</html>
