<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Scanner - Pagarnusa Unusia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/instascan/1.0.0/instascan.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="max-w-md mx-auto p-4">
        <div class="bg-[#1b7548] text-white p-6 rounded-t-2xl text-center shadow-lg">
            <h1 class="text-xl font-bold uppercase tracking-widest">Validasi Pesanan</h1>
            <p class="text-xs opacity-80">Scan QR Code pada Kwitansi Pelanggan</p>
        </div>

        <div class="bg-black relative aspect-square overflow-hidden shadow-inner">
            <video id="preview" class="w-full h-full object-cover"></video>
            <div class="absolute inset-0 border-[40px] border-black/40 pointer-events-none">
                <div class="w-full h-full border-2 border-dashed border-white/60 rounded-lg"></div>
            </div>
        </div>

        <div id="statusBox" class="bg-white p-6 rounded-b-2xl shadow-lg border-t border-gray-100">
            <div id="idleState">
                <p class="text-center text-gray-500 italic text-sm">Mengarahkan kamera ke QR Code...</p>
            </div>

            <div id="resultState" class="hidden animate-fade-in">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">DATA DITEMUKAN</span>
                    <span id="resOrderID" class="font-mono font-bold text-gray-800"></span>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-400 block uppercase">Nama Pemesan</label>
                        <p id="resNama" class="font-semibold text-gray-800 text-lg"></p>
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 block uppercase">Rincian Item</label>
                        <ul id="resItems" class="text-sm text-gray-600 list-disc list-inside"></ul>
                    </div>
                    <div class="pt-3 border-t">
                        <label class="text-[10px] text-gray-400 block uppercase">Total Bayar</label>
                        <p id="resTotal" class="font-bold text-[#1b7548] text-xl"></p>
                    </div>
                </div>

                <button onclick="resetScanner()" class="w-full mt-6 bg-gray-800 text-white py-3 rounded-xl font-bold hover:bg-black transition">
                    SCAN LAGI
                </button>
            </div>

            <div id="loadingState" class="hidden text-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#1b7548] mx-auto"></div>
                <p class="text-sm text-gray-500 mt-2">Mencari di database...</p>
            </div>
        </div>
    </div>

<script>
    // --- KONFIGURASI ---
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbxw19azk92bUVGoGJBBgYYaM69W0qu0ukA3ED6yth0yTgGxJmDqVqSNyTfMhXiQNgL8/exec';

    let scanner = new Instascan.Scanner({ video: document.getElementById('preview'), mirror: false });

    // Event saat QR terbaca
    scanner.addListener('scan', function (content) {
        console.log("Terdeteksi ID: " + content);
        cariDataPesanan(content.trim());
    });

    // Akses Kamera
    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            // Pilih kamera belakang jika ada, jika tidak pakai kamera pertama yang tersedia
            let backCam = cameras.find(c => c.name.toLowerCase().includes('back')) || cameras[0];
            scanner.start(backCam);
        } else {
            alert('Kamera tidak ditemukan.');
        }
    }).catch(function (e) {
        alert('Error kamera: ' + e);
    });

    async function cariDataPesanan(orderID) {
        showState('loading');
        
        try {
            // Memanggil Apps Script dengan parameter type=pesanan
            const response = await fetch(scriptUrl + '?type=pesanan&t=' + Date.now());
            const database = await response.json(); // Berisi array dari Sheet Pesanan
            
            // Cari data di kolom pertama (index 0 adalah Order ID)
            const row = database.find(r => r[0].toString() === orderID.toString());

            if (row) {
                // Mapping data sesuai urutan appendRow di Apps Script Anda:
                // index 0: Order ID
                // index 1: Nama
                // index 5: Item (Lembaga + Ukuran)
                // index 7: Harga Total
                const dataFormatted = {
                    orderID: row[0],
                    nama: row[1],
                    itemRincian: row[5],
                    total: row[7]
                };
                tampilkanHasil(dataFormatted, orderID);
            } else {
                alert("Pesanan dengan ID " + orderID + " tidak ditemukan di database.");
                resetScanner();
            }
        } catch (error) {
            console.error(error);
            alert("Gagal terhubung ke database. Pastikan Web App sudah di-Deploy sebagai 'Anyone'.");
            resetScanner();
        }
    }

    function tampilkanHasil(data, orderID) {
        document.getElementById('resOrderID').innerText = "#" + orderID;
        document.getElementById('resNama').innerText = data.nama || "Tanpa Nama";
        
        // Format Rupiah untuk Total
        const totalHarga = parseInt(data.total) || 0;
        document.getElementById('resTotal').innerText = "Rp " + totalHarga.toLocaleString('id-ID');
        
        // Render Item Pesanan
        const itemContainer = document.getElementById('resItems');
        itemContainer.innerHTML = '';
        
        let li = document.createElement('li');
        li.innerText = data.itemRincian || "Detail item tidak tersedia";
        itemContainer.appendChild(li);

        showState('result');
    }

    function showState(state) {
        document.getElementById('idleState').classList.add('hidden');
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('resultState').classList.add('hidden');

        if (state === 'loading') document.getElementById('loadingState').classList.remove('hidden');
        if (state === 'result') document.getElementById('resultState').classList.remove('hidden');
        if (state === 'idle') document.getElementById('idleState').classList.remove('hidden');
    }

    function resetScanner() {
        showState('idle');
    }
</script>

    <style>
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</body>
</html>